<!DOCTYPE html>
<html lang="en-CA">
<head>
  <meta charset="utf-8">
  <title>Kub Kars and Scout Trucks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/libs/bootstrap-5.3.3-dist/css/bootstrap.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="/assets/images/Scouts-Badge.png">
  <script src="/libs/jquery-3.7.1.min.js" type="application/javascript"></script>
  <script src="/libs/bootstrap-5.3.3-dist/js/bootstrap.js" type="application/javascript"></script>
  <script src="/libs/popper.min.js" type="application/javascript"></script>
  <script src="/libs/common.js" type="application/javascript"></script>
  
  <script>

    // A function to show an alert when there is an error
    function showAlert(CustomInnerHTML) 
    {
        const alertPlaceholder = document.getElementById('liveAlertPlaceholder')
        const appendAlert = () => 
        {
            const wrapper = document.createElement('div')
            wrapper.innerHTML = [CustomInnerHTML].join('')
            alertPlaceholder.append(wrapper)
        }
        appendAlert();
    }
    
    function CleanseSignatureText(input) 
    {
        if (typeof input !== 'string') 
        {
            return input; // If it's not a string, return as is
        }
    
        // Escape characters that could be used for SQL injection
        return input
            .replace(/[^a-zA-Z0-9]/g, "")  // Remove non-alphanumeric characters
            .replace(/\s/g, '')            // Remove spaces
            .replace(/'/g, '')             // Remove quotes
            .replace(/"/g, '')             // Remove double quotes
            .replace(/;/g, '')             // Remove semicolons
            .replace(/--/g, '')            // Remove SQL comments
            .replace(/\\/g, '')            // Remove backslashes
            .replace(/[\n\r]/g, '');       // Remove newline characters
    }
    
    // A function to call the API to put the Track IDs in the dropdown
    async function fetchDataAndPopulateDropdown(apiurl)
    {
        try
        {
            const response = await fetch(apiurl);
            if (!response.ok)
            {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const data = await response.json();
            const dropdown = document.getElementById('frmTrackInput');
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.track;
                option.textContent = item.track;
                dropdown.appendChild(option);
            });
        } 
        catch (error)
        {
            showAlert(['<div class="alert alert-danger fade show" role="alert">',
                       '  <strong>Ooops!</strong> There was an error during retrieval of data. <a href="setting_up.html" class="alert-link">Reload Page</a> OR <a href="index.html" class="alert-link">Start Again</a>. Error Text: ',
                       error,
                       '</div>'])
        }
    }
    
    // A function to update the summary data for the selected track
    // data[0] is used because the summary ALWAYS returns ONE record.
    
    async function fetchAndPopulateRaceAndSummary(TrackSummaryURL,RaceURL,VehiclesPerHeatURL)
    {
        // A function to add the Ordinal positions to the Result Selection
        
        function addOptionsToSelect(count, selectElementId) 
        {
            // Get the select element by its id
            const selectElement = document.getElementById(selectElementId);

            // Clear all existing options
            selectElement.innerHTML = "";
            
            // Add a placeholder option with no selection
            const placeholderOption = document.createElement("option");
            placeholderOption.value = "default";
            placeholderOption.text = "Select Position";
            placeholderOption.disabled = true; // Prevent the placeholder from being selected
            placeholderOption.selected = true; // Ensure it's selected by default
            selectElement.appendChild(placeholderOption);
            
            // Add a "Did Not Race" option
            const DNROption = document.createElement("option");
            DNROption.value = "1000";
            DNROption.text = "Did Not Race";
            DNROption.disabled = false; // It can be selected
            DNROption.selected = false; // It's not selected by default
            selectElement.appendChild(DNROption);
            
            // Helper function to convert a number to its ordinal form
            function getOrdinal(num) 
            {
                const suffixes = ["th", "st", "nd", "rd"];
                const remainder = num % 100;
                return num + (suffixes[(remainder - 20) % 10] || suffixes[remainder] || suffixes[0]);
            }
            
            // Add the required number of new options
            for (let i = 1; i <= count; i++) 
            {
                // Create a new option element
                const option = document.createElement("option");
                option.value = `${i}`;
                option.text = getOrdinal(i); // Set the text as the ordinal of i
                
                // Add the option to the select element
                selectElement.appendChild(option);
            }
        }
        
        try
        {
            const vph_response = await fetch(VehiclesPerHeatURL);
            if (!vph_response.ok)
            {
                throw new Error(`HTTP error! Status: ${vph_response.status}`);
            }
            const vph_data = await vph_response.json();
            var vehicles_per_heat = vph_data[0].VehiclesPerHeat
            
            // Vehicles Per Heat now determines the positions available in the Results Area
            // if VPH = 2, there can only be 1st and 2nd.
            // if VPH = 3, there can only be 1st, 2nd, 3rd
            // etc
            // Clear the options from all SELECTs
            // Based on VPH, these will be repopulated shortly.
            document.getElementById('CurLane1ResultSelect').innerHTML = "";
            document.getElementById('CurLane2ResultSelect').innerHTML = "";
            document.getElementById('CurLane3ResultSelect').innerHTML = "";
            document.getElementById('CurLane4ResultSelect').innerHTML = "";
            document.getElementById('CurLane5ResultSelect').innerHTML = "";
            document.getElementById('CurLane6ResultSelect').innerHTML = "";
            
            const t_response = await fetch(TrackSummaryURL);
            if (!t_response.ok) 
            {
                throw new Error(`HTTP error! Status: ${t_response.status}`);
            }
            const t_data = await t_response.json();
            
            // Heat Summary
            document.getElementById('statHeatPercentComplete').innerHTML = htmlEncode(t_data[0].heats_pct_complete);
            document.getElementById('statTotalHeats').innerHTML = htmlEncode(t_data[0].total_heat_count);
            document.getElementById('statFinishedHeats').innerHTML = htmlEncode(t_data[0].finished_heats);
            document.getElementById('statUnfinishedHeats').innerHTML = htmlEncode(t_data[0].unfinished_heats);
            document.getElementById('statCurrentHeat').innerHTML = htmlEncode(t_data[0].current_heat);
            document.getElementById('statNextHeat').innerHTML = htmlEncode(t_data[0].next_heat);
            // Runoff Summary
            document.getElementById('statTotalRunOffs').innerHTML = htmlEncode(t_data[0].total_runoff_count);
            document.getElementById('statFinishedRunOffs').innerHTML = htmlEncode(t_data[0].finished_runoffs);
            document.getElementById('statUnfinishedRunOffs').innerHTML = htmlEncode(t_data[0].unfinished_runoffs);
            document.getElementById('statROPercentComplete').innerHTML = htmlEncode(t_data[0].runoffs_pct_complete);
            document.getElementById('statCurrentRunOff').innerHTML = htmlEncode(t_data[0].current_runoff);
            document.getElementById('statNextRunOff').innerHTML = htmlEncode(t_data[0].next_runoff);
            
            // TODO: Images or Colours for visibility?
            
            
            // Show the heats if they are not finished
            if ( parseFloat(t_data[0].heats_pct_complete) < 100 && parseFloat(t_data[0].heats_pct_complete) >= 0 )
            {
                // Current Heat Data
                const ch_response = await fetch(RaceURL + '/' + t_data[0].current_heat);
                if (!ch_response.ok) 
                {
                    throw new Error(`HTTP error! Status: ${ch_response.status}`);
                }
                const ch_data = await ch_response.json();
                
                // Hide the "Races Complete" div
                $('#AllRacesComplete').hide();
                // Show the Heats, hide the run-offs (not started)
                $('#HeatSummary').show();
                $('#RunOffSummary').hide();
                
                // Current Race Updates:
                document.getElementById('CurRaceNum').innerHTML = htmlEncode(t_data[0].current_heat);
                document.getElementById('CurRaceType').innerHTML = 'Heat';
                
                // Save Cookies
                setCookie("KubKarsScoutTrucks_RaceType",1,1);
                setCookie("KubKarsScoutTrucks_RaceTypeTxt",'Heat',1);
                setCookie('KubKarsScoutTrucks_HeatID',htmlEncode(t_data[0].current_heat,1));
                
                // There's probably a nicer way of doing this, but this works.
                
                // Hide them all
                $('#CurLane1Row').hide();
                $('#CurLane2Row').hide();
                $('#CurLane3Row').hide();
                $('#CurLane4Row').hide();
                $('#CurLane5Row').hide();
                $('#CurLane6Row').hide();
                // Result rows get hidden too
                $('#CurLane1ResultRow').hide();
                $('#CurLane2ResultRow').hide();
                $('#CurLane3ResultRow').hide();
                $('#CurLane4ResultRow').hide();
                $('#CurLane5ResultRow').hide();
                $('#CurLane6ResultRow').hide();
                
                // Show them based on the vehicles_per_heat setting

                if ( vehicles_per_heat == 6 ) 
                {
                    document.getElementById('CurLane6CarID').innerHTML = htmlEncode(ch_data[0].lane6_carNumber + ' - ' + ch_data[0].lane6_driver);
                    addOptionsToSelect(vehicles_per_heat,'CurLane6ResultSelect');
                    $('#CurLane6Row').show();
                    $('#CurLane6ResultRow').show();
                }
                
                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 ) 
                {
                    document.getElementById('CurLane5CarID').innerHTML = htmlEncode(ch_data[0].lane5_carNumber + ' - ' + ch_data[0].lane5_driver);
                    addOptionsToSelect(vehicles_per_heat,'CurLane5ResultSelect');
                    $('#CurLane5Row').show();
                    $('#CurLane5ResultRow').show();
                }
                
                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 ) 
                {
                    document.getElementById('CurLane4CarID').innerHTML = htmlEncode(ch_data[0].lane4_carNumber + ' - ' + ch_data[0].lane4_driver);
                    addOptionsToSelect(vehicles_per_heat,'CurLane4ResultSelect');
                    $('#CurLane4Row').show();
                    $('#CurLane4ResultRow').show();
                }

                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 ) 
                {
                    document.getElementById('CurLane3CarID').innerHTML = htmlEncode(ch_data[0].lane3_carNumber + ' - ' + ch_data[0].lane3_driver);
                    addOptionsToSelect(vehicles_per_heat,'CurLane3ResultSelect');
                    $('#CurLane3Row').show();
                    $('#CurLane3ResultRow').show();
                }

                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 || vehicles_per_heat == 2 ) 
                {
                    document.getElementById('CurLane2CarID').innerHTML = htmlEncode(ch_data[0].lane2_carNumber + ' - ' + ch_data[0].lane2_driver);
                    addOptionsToSelect(vehicles_per_heat,"CurLane2ResultSelect");
                    $('#CurLane2Row').show();
                    $('#CurLane2ResultRow').show();
                    document.getElementById('CurLane1CarID').innerHTML = htmlEncode(ch_data[0].lane1_carNumber + ' - ' + ch_data[0].lane1_driver);
                    addOptionsToSelect(vehicles_per_heat,'CurLane1ResultSelect');
                    $('#CurLane1Row').show();
                    $('#CurLane1ResultRow').show();
                }
                
                // Show Current Race
                $('#CurrentRace').show();
                $('#CurrentRaceResults').show();
                $('#SubmitResults').show();
                $('#Rerun').show();
            }
            // Hide the heats and show the runoffs if these are incomplete
            else if ( parseFloat(t_data[0].heats_pct_complete) == 100 && parseFloat(t_data[0].runoffs_pct_complete) < 100 && parseFloat(t_data[0].runoffs_pct_complete) >= 0 )
            {
                // Hide the "Races Complete" div
                $('#AllRacesComplete').hide();
                // Hide the heats
                $('#HeatSummary').hide();
                // Show the Run Offs
                $('#RunOffSummary').show();
                
                // Current RunOff Data
                const cr_response = await fetch(RaceURL + '/' + t_data[0].current_runoff);
                if (!cr_response.ok) 
                {
                    throw new Error(`HTTP error! Status: ${cr_response.status}`);
                }
                const cr_data = await cr_response.json();
                
                // Current Race Updates:
                document.getElementById('CurRaceNum').innerHTML = htmlEncode(t_data[0].current_runoff);
                document.getElementById('CurRaceType').innerHTML = 'RunOff';
                
                // Save Cookies
                setCookie("KubKarsScoutTrucks_RaceType",2,1);
                setCookie("KubKarsScoutTrucks_RaceTypeTxt",'RunOff',1);
                setCookie('KubKarsScoutTrucks_HeatID',htmlEncode(t_data[0].current_runoff,1));
                
                // There's probably a nicer way of doing this, but this works.
                // Hide them all
                $('#CurLane1Row').hide();
                $('#CurLane2Row').hide();
                $('#CurLane3Row').hide();
                $('#CurLane4Row').hide();
                $('#CurLane5Row').hide();
                $('#CurLane6Row').hide();
                
                $('#CurLane1ResultRow').hide();
                $('#CurLane2ResultRow').hide();
                $('#CurLane3ResultRow').hide();
                $('#CurLane4ResultRow').hide();
                $('#CurLane5ResultRow').hide();
                $('#CurLane6ResultRow').hide();
                
                // Show them based on the vehicles_per_heat setting
                if ( vehicles_per_heat == 6 ) 
                {
                    document.getElementById('CurLane6CarID').innerHTML = htmlEncode(cr_data[0].lane6_carNumber + ' - ' + cr_data[0].lane6_driver);
                    addOptionsToSelect(vehicles_per_heat,'CurLane6ResultSelect');
                    $('#CurLane6Row').show();
                    $('#CurLane6ResultRow').show();
                }
                
                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 ) 
                {
                    document.getElementById('CurLane5CarID').innerHTML = htmlEncode(cr_data[0].lane5_carNumber + ' - ' + cr_data[0].lane5_driver);
                    addOptionsToSelect(vehicles_per_heat,'CurLane5ResultSelect');
                    $('#CurLane5Row').show();
                    $('#CurLane5ResultRow').show();
                }
                
                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 ) 
                {
                    document.getElementById('CurLane4CarID').innerHTML = htmlEncode(cr_data[0].lane4_carNumber + ' - ' + cr_data[0].lane4_driver);
                    addOptionsToSelect(vehicles_per_heat,'CurLane4ResultSelect');
                    $('#CurLane4Row').show();
                    $('#CurLane4ResultRow').show();
                }

                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 ) 
                {
                    document.getElementById('CurLane3CarID').innerHTML = htmlEncode(cr_data[0].lane3_carNumber + ' - ' + cr_data[0].lane3_driver);
                    addOptionsToSelect(vehicles_per_heat,'CurLane3ResultSelect');
                    $('#CurLane3Row').show();
                    $('#CurLane3ResultRow').show();
                }

                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 || vehicles_per_heat == 2 ) 
                {
                    document.getElementById('CurLane2CarID').innerHTML = htmlEncode(cr_data[0].lane2_carNumber + ' - ' + cr_data[0].lane2_driver);
                    addOptionsToSelect(vehicles_per_heat,'CurLane2ResultSelect');
                    $('#CurLane2Row').show();
                    $('#CurLane2ResultRow').show();
                    document.getElementById('CurLane1CarID').innerHTML = htmlEncode(cr_data[0].lane1_carNumber + ' - ' + cr_data[0].lane1_driver);
                    addOptionsToSelect(vehicles_per_heat,'CurLane1ResultSelect');
                    $('#CurLane1Row').show();
                    $('#CurLane1ResultRow').show();
                }

                // Show Current Race & Results
                $('#CurrentRace').show();
                $('#CurrentRaceResults').show();
                $('#SubmitResults').show();
                $('#Rerun').show();
                
            }
            // Additional logic to add some visual aids (Complete/Incomplete)
            else if ( parseFloat(t_data[0].heats_pct_complete) == 100 && parseFloat(t_data[0].runoffs_pct_complete) == 100 )
            {
                // Unset Cookies
                setCookie("KubKarsScoutTrucks_RaceType",'',1);
                setCookie("KubKarsScoutTrucks_RaceTypeTxt",'',1);
                setCookie('KubKarsScoutTrucks_HeatID','',1);

                // Hide everything not required
                $('#HeatSummary').hide();
                $('#RunOffSummary').hide();
                $('#CurrentRace').hide();
                $('#CurrentRaceResults').hide();
                $('#SubmitResults').hide();
                $('#Rerun').hide();
                // Show the "Races Complete" div
                $('#AllRacesComplete').show();
            }
        } 
        catch (error) 
        {
            showAlert(['<div class="alert alert-danger fade show" role="alert">',
                       '  <strong>Ooops!</strong> There was an error during retrieval of data. <a href="setting_up.html" class="alert-link">Reload Page</a> OR <a href="index.html" class="alert-link">Start Again</a>. Error Text: ',
                       error,
                       '</div>']);
        }
    }

    function refreshTrackData()
    {
        // item is the option that was selected, might be the default or an actual track id
        var item = document.getElementById("frmTrackInput").value;
        
        if (item == "default")
        {
            // Hide everything when the default option is selected
            $('#TrackContent').hide();
            $('#AllRacesComplete').hide();
        }
        else 
        {
            var dbID = getCookie("KubKarsScoutTrucks_dbID");
            // dbID must be 1 or 2
            if (dbID == 1 || dbID == 2) 
            {
                if (dbID == 1) 
                {
                    var TrackSummaryURL = window.location.origin + '/api/cubs/tracksummary/' + item;
                    var RaceURL = window.location.origin + '/api/cubs/race/' + item;
                    var VehiclesPerHeatURL = window.location.origin + '/api/cubs/vehicles_per_heat';
                }
                if (dbID == 2)
                {
                    var TrackSummaryURL = window.location.origin + '/api/scouts/tracksummary/' + item;
                    var RaceURL = window.location.origin + '/api/scouts/race/' + item;
                    var VehiclesPerHeatURL = window.location.origin + '/api/scouts/vehicles_per_heat';
                }
                // Show the Content
                $('#TrackContent').show();
                
                // Refresh the summary and race data
                fetchAndPopulateRaceAndSummary(TrackSummaryURL,RaceURL,VehiclesPerHeatURL);
                
            }
        }
    }
    
    async function SaveResults(VehiclesPerHeatURL,SaveResultsURL,Signature)
    {
        // This function gets called when the Save Results button is pressed
        // The job of this function is to check that the user filled in the results correctly
        // Check there are no ties
        // Call the API
        // Check the return code. The function should always complete successfully, but returns
        // an integer (usually a 0).
        // If it is anything other than 0, then there was a data error
        
        const vph_response = await fetch(VehiclesPerHeatURL);
        if (!vph_response.ok)
        {
            throw new Error(`HTTP error! Status: ${vph_response.status}`);
        }
        const vph_data = await vph_response.json();
        var vehicles_per_heat = vph_data[0].VehiclesPerHeat
        
        // Check #1: Did the user make a selection for all boxes (depending on VPH):
        // The value of the position is just an integer, 1 thru VPH
        // The text shown in the dropdown is the ordinal (e.g. 1st, 2nd, etc)
        // Notice we don't use "else if"; because we want to check all applicable option selects
        
        const list = [1, 2, 3, 4, 5, 6, 1000];
        
        if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 || vehicles_per_heat == 2 ) 
        {
            if (!list.includes(parseInt(document.getElementById("CurLane1ResultSelect").value)) ) 
            {
                // Show Modal
                var element = document.getElementById("modalbutton");
                element.classList = "";
                element.classList.add("btn");
                element.classList.add("btn-danger");
                document.getElementById('ModalTitle').innerHTML = htmlEncode('Lane 1 missing');
                document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Position of Lane 1 is missing');
                $('#ErrorBox').modal('show');
                return;
            }
            if (!list.includes(parseInt(document.getElementById("CurLane2ResultSelect").value)) ) 
            {
                // Show Modal
                var element = document.getElementById("modalbutton");
                element.classList = "";
                element.classList.add("btn");
                element.classList.add("btn-danger");
                document.getElementById('ModalTitle').innerHTML = htmlEncode('Lane 2 missing');
                document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Position of Lane 2 is missing');
                $('#ErrorBox').modal('show');
                return;
            }
        }
        if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 ) 
        {
            if (!list.includes(parseInt(document.getElementById("CurLane3ResultSelect").value)) ) 
            {
                // Show Modal
                var element = document.getElementById("modalbutton");
                element.classList = "";
                element.classList.add("btn");
                element.classList.add("btn-danger");
                document.getElementById('ModalTitle').innerHTML = htmlEncode('Lane 3 missing');
                document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Position of Lane 3 is missing');
                $('#ErrorBox').modal('show');
                return;
            }
        }
        if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 ) 
        {
            if (!list.includes(parseInt(document.getElementById("CurLane4ResultSelect").value)) ) 
            {
                // Show Modal
                var element = document.getElementById("modalbutton");
                element.classList = "";
                element.classList.add("btn");
                element.classList.add("btn-danger");
                document.getElementById('ModalTitle').innerHTML = htmlEncode('Lane 4 missing');
                document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Position of Lane 4 is missing');
                $('#ErrorBox').modal('show');
                return;
            }
        }
        if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 ) 
        {
            if (!list.includes(parseInt(document.getElementById("CurLane5ResultSelect").value)) ) 
            {
                // Show Modal
                var element = document.getElementById("modalbutton");
                element.classList = "";
                element.classList.add("btn");
                element.classList.add("btn-danger");
                document.getElementById('ModalTitle').innerHTML = htmlEncode('Lane 5 missing');
                document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Position of Lane 5 is missing');
                $('#ErrorBox').modal('show');
                return;
            }
        }
        if ( vehicles_per_heat == 6 ) 
        {
            if ( !list.includes(parseInt(document.getElementById("CurLane6ResultSelect").value)) ) 
            {
                // Show Modal
                var element = document.getElementById("modalbutton");
                element.classList = "";
                element.classList.add("btn");
                element.classList.add("btn-danger");
                document.getElementById('ModalTitle').innerHTML = htmlEncode('Lane 6 missing');
                document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Position of Lane 6 is missing');
                $('#ErrorBox').modal('show');
                return;
            }
            
        }
        
        // User Selected List of Values
        const user_selected = []
        
        // The adjusted VPH is used to verify the max position if there are 1000's present.
        var adj_vph = vehicles_per_heat;
        
        // Some may be NULL depending on the VPH, so don't add the NaNs to the list.
        if (Number.isInteger(parseInt(document.getElementById("CurLane1ResultSelect").value))) 
        {
            if ( parseInt(document.getElementById("CurLane1ResultSelect").value) == 1000 ) 
            {
                adj_vph--;
            }
            else
            {
                user_selected.push(parseInt(document.getElementById("CurLane1ResultSelect").value));
            }
            aResult1 = document.getElementById("CurLane1ResultSelect").value;
        }
        else
        {
            aResult1 = 'null'
        }
        
        if (Number.isInteger(parseInt(document.getElementById("CurLane2ResultSelect").value))) 
        {
            if ( parseInt(document.getElementById("CurLane2ResultSelect").value) == 1000 ) 
            {
                adj_vph--;
            }
            else
            {
                user_selected.push(parseInt(document.getElementById("CurLane2ResultSelect").value));
            }
            aResult2 = document.getElementById("CurLane2ResultSelect").value;
        }
        else
        {
            aResult2 = 'null'
        }
        
        if (Number.isInteger(parseInt(document.getElementById("CurLane3ResultSelect").value))) 
        {
            if ( parseInt(document.getElementById("CurLane3ResultSelect").value) == 1000 ) 
            {
                adj_vph--;
            }
            else
            {
                user_selected.push(parseInt(document.getElementById("CurLane3ResultSelect").value));
            }
            aResult3 = document.getElementById("CurLane3ResultSelect").value;
        }
        else
        {
            aResult3 = 'null'
        }
        
        if (Number.isInteger(parseInt(document.getElementById("CurLane4ResultSelect").value))) 
        {
            if ( parseInt(document.getElementById("CurLane4ResultSelect").value) == 1000 ) 
            {
                adj_vph--;
            }
            else
            {
                user_selected.push(parseInt(document.getElementById("CurLane4ResultSelect").value));
            }
            aResult4 = document.getElementById("CurLane4ResultSelect").value;
        }
        else
        {
            aResult4 = 'null'
        }
        
        if (Number.isInteger(parseInt(document.getElementById("CurLane5ResultSelect").value))) 
        {
            if ( parseInt(document.getElementById("CurLane5ResultSelect").value) == 1000 ) 
            {
                adj_vph--;
            }
            else
            {
                user_selected.push(parseInt(document.getElementById("CurLane5ResultSelect").value));
            }
            aResult5 = document.getElementById("CurLane5ResultSelect").value;
        }
        else
        {
            aResult5 = 'null'
        }
        
        if (Number.isInteger(parseInt(document.getElementById("CurLane6ResultSelect").value))) 
        {
            if ( parseInt(document.getElementById("CurLane6ResultSelect").value) == 1000 ) 
            {
                adj_vph--;
            }
            else
            {
                user_selected.push(parseInt(document.getElementById("CurLane6ResultSelect").value));
            }
            aResult6 = document.getElementById("CurLane6ResultSelect").value;
        }
        else
        {
            aResult6 = 'null'
        }

        // Do the positions make sense? if VPH = 2, but one is 1000, did the other lane come 2nd? It should be 1st.
        // adj_vph should be the max position allowed. If there's a position greater, they need to re-enter.
        if ( Math.max(...user_selected) > adj_vph ) 
        {
            // Show Modal
            document.getElementById('ModalTitle').innerHTML = htmlEncode('Incorrect position selected');
            document.getElementById('ErrorBoxText').innerHTML = htmlEncode('At least one DNF is present, please correct the selected positions, or rerun the race.');
            $('#ErrorBox').modal('show');
            return;
        }
        
        // Did we get a tie?
        // Check for "duplicate" entries
        // Note that the "1000" entries are ignored as duplicates
        // https://stackoverflow.com/questions/49215358/checking-for-duplicate-strings-in-javascript-array
        function hasDuplicates(arr) 
        {
            var counts = [];
            for (var i = 0; i <= arr.length; i++) 
            {
                if (counts[arr[i]] === undefined) 
                {
                    counts[arr[i]] = 1;
                } 
                else 
                {
                    return true;
                }
            }
            return false;
        }
        
        if ( hasDuplicates(user_selected) == true ) 
        {
            // Show Modal
            document.getElementById('ModalTitle').innerHTML = htmlEncode('Ties Not Allowed');
            document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Ties are not allowed - please correct the selected positions, or rerun the race.');
            $('#ErrorBox').modal('show');
            return;
        }
        
        // Call the API
        const upd_response = await fetch(SaveResultsURL + '/' + aResult1 + '/' + aResult2 + '/' + aResult3 + '/' + aResult4 + '/' + aResult5 + '/' + aResult6 + '/' + Signature);
        
        if (!upd_response.ok)
        {
            throw new Error(`HTTP error! Status: ${upd_response.status}`);
        }
        var upd_data = await upd_response.json();
        
        var upd_return_code = upd_data[0].return_code;
        
        // Verify the result
        if ( upd_return_code == 0 )
        {
            // SUCCESS
            document.getElementById('ModalTitle').innerHTML = htmlEncode('Success!');
            var element = document.getElementById("modalbutton");
            element.classList = "";
            element.classList.add("btn");
            element.classList.add("btn-success");
            document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Race results have been saved! Page will refresh.');
            $('#ErrorBox').modal('show');
        }
        else if ( upd_return_code > 0 ) 
        {
            // Error when saving results
            document.getElementById('ModalTitle').innerHTML = htmlEncode('Error');
            var element = document.getElementById("modalbutton");
            element.classList = "";
            element.classList.add("btn");
            element.classList.add("btn-danger");
            document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Error in submission. Contact Support. Return Code from database: ' + upd_return_code);
            $('#ErrorBox').modal('show');
        }
        
    }
    
    function CallSaveResults() 
    {
    
        try
        {
            // Get the Cookie data
            var dbID = getCookie("KubKarsScoutTrucks_dbID");
            var nmPerson = getCurrentUserId().then(userId => {
                              if (userId) {
                                console.log(`Logged in user’s ID: ${userId}`);
                              } else {
                                console.log('No user ID available');
                              }
                           });
            var HeatID = getCookie("KubKarsScoutTrucks_HeatID");
            var RaceType = getCookie("KubKarsScoutTrucks_RaceType");
            var RaceTypeTxt = getCookie("KubKarsScoutTrucks_RaceTypeTxt");
            var Signature = htmlEncode(CleanseSignatureText(nmPerson));
            
            // dbID must be a 1 or 2
            if (dbID == 1 || dbID == 2) {
                TrackID = document.getElementById("frmTrackInput").value;
                // Change data source based on cookie, and update the Section based on the cookie
                if (dbID == 1) {
                    var VehiclesPerHeatURL = window.location.origin + '/api/cubs/vehicles_per_heat';
                    var SaveResultsURL = window.location.origin + '/api/cubs/saveresults/' + RaceType + '/' + TrackID + '/' + HeatID;
                }
                if (dbID == 2) {
                    var VehiclesPerHeatURL = window.location.origin + '/api/scouts/vehicles_per_heat';
                    var SaveResultsURL = window.location.origin + '/api/scouts/saveresults/' + RaceType + '/' + TrackID + '/' + HeatID;
                }
                
                // Call SaveResults
                SaveResults(VehiclesPerHeatURL,SaveResultsURL,Signature);
                
                // Refresh the page
                refreshTrackData();
            }
        
        } catch (error) 
        {
            // draw an alert box with the error visible
            showAlert(['<div class="alert alert-danger fade show" role="alert">',
                       '  <strong>Ooops!</strong> There was an error during saving of data. You can try doing it again, or <a href="recording.html" class="alert-link">Reload Page</a>',
                       error,
                       '</div>']);
        }
        
    }
    
    // A function that is called when a user requests a rerun for a specific race
    // Although submitting the API to unlock a heat/runoff won't break anything
    // it might be best to disable the button that was pressed to reduce the temptation.
    // Also this would serve as a visual clue that the unlock has completed.
    
    async function UnlockHeat(UnlockURL, Track, Heat, Signature, ButtonID) 
    {
        
        // Call the API to actually unlock the heat
        
        const unl_response = await fetch(UnlockURL + '/' + Track + '/' + Heat + '/' + Signature);
        if (!unl_response.ok)
        {
            throw new Error(`HTTP error! Status: ${unl_response.status}`);
        }
        var unl_data = await unl_response.json();
        
        var upd_return_code = unl_data[0].return_code;
        
        // Verify the result
        if ( upd_return_code == 0 )
        {
            // SUCCESS
            // Change the colour to success, and disable it.
            var element = document.getElementById(ButtonID);
            element.classList = "";
            element.classList.add("btn");
            element.classList.add("btn-success");
            element.classList.add("disabled");
            element.innerText = 'Unlocked!';
        }
        else if ( upd_return_code > 0 ) 
        {
            // Error when unlocking, show modal.
            document.getElementById('ModalTitle').innerHTML = htmlEncode('Error');
            var element = document.getElementById("modalbutton");
            element.classList = "";
            element.classList.add("btn");
            element.classList.add("btn-danger");
            document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Error in submission. Contact Support. Return Code from database: ' + upd_return_code);
            $('#ErrorBox').modal('show');
        }
        
    }
    
    
    // This function gets the set of Heats/Runoffs to be potentially "rerun"
    // It then populates the 5 available rows in the table
    
    async function fetchAndShowReruns(LatestFinishedURL,UnlockURL,RaceTypeTxt,Signature) {
    
        // Call the API
        const fin_response = await fetch(LatestFinishedURL);
        
        if (!fin_response.ok)
        {
            throw new Error(`HTTP error! Status: ${fin_response.status}`);
        }
        var fin_data = await fin_response.json();
        
        // If the top 5 finished races is actually zero, then we are probably at the start
        // Or, there could be something wrong.
        // Pleading ignorance.
        if (fin_data.length == 0 ) 
        {
            // Show the modal.
            document.getElementById('ModalTitle').innerHTML = htmlEncode('Nothing to do!');
            var element = document.getElementById("modalbutton");
            element.classList = "";
            element.classList.add("btn");
            element.classList.add("btn-danger");
            document.getElementById('ErrorBoxText').innerHTML = htmlEncode('No finished ' + RaceTypeTxt + 's found, returning to regular view.');
            $('#ErrorBox').modal('show');
            HidePotentialReruns();
            return;
        }
        
        // The order of the array elements is important.
        // The most recent race is always at the top
        
        for (var i = 0; i < fin_data.length; i++) 
        {
            // RerunRow = i + 1
            var RerunRow = i + 1;
            var RerunRow_1 = 'RR' + RerunRow + '_1';
            var RerunRow_2 = 'RR' + RerunRow + '_2';
            // Make the first column just the Heat #
            document.getElementById(RerunRow_1).innerHTML = "";
            document.getElementById(RerunRow_1).innerHTML = '<strong>' + RaceTypeTxt + ': # ' + fin_data[i].heat + '</strong>';
            // Make the second column a button that calls a function to unlock that heat
            document.getElementById(RerunRow_2).innerHTML = "";
            document.getElementById(RerunRow_2).innerHTML = '<button type="button" class="btn btn-primary" onclick="UnlockHeat(' + '\'' + UnlockURL + '\'' + ',' + fin_data[i].track + ',' + fin_data[i].heat + ',' + '\'' + Signature + '\'' + ',' + '\'' + RerunRow_2 + 'btn' + '\'' + ')" id="' + RerunRow_2 + 'btn' + '">Unlock</button>';
        }
        
        // If the top 5 isn't actually 5, we hide the rows that won't have anything in them
        if (fin_data.length == 4 ) {
            $('#RerunRow5').hide();
        }
        if (fin_data.length == 3 ) {
            $('#RerunRow4').hide();
            $('#RerunRow5').hide();
        }
        if (fin_data.length == 2 ) {
            $('#RerunRow3').hide();
            $('#RerunRow4').hide();
            $('#RerunRow5').hide();
        }
        if (fin_data.length == 1 ) {
            $('#RerunRow2').hide();
            $('#RerunRow3').hide();
            $('#RerunRow4').hide();
            $('#RerunRow5').hide();
        }
        
    }
    
    // This function is called when someone presses the "Oops I made a mistake" button
    // It allows someone to re-open a race
    // The function will populate a table with the last 5 races
    // Since the logic in the app forces them to run the races in numerical order, this is
    // how the reruns will be returned.
    // Note that the functions will not return a mixture of Heats/Runoffs; since they are
    // separate.
    
    function ShowPotentialReruns() {
        
        // Hide the other sections to make it easier to see
        // Provide a way of "cancelling" the Ooops; show the "cancel" button
        $('#TrackSummary').hide();
        $('#CurrentRace').hide();
        $('#CurrentRaceResults').hide();
        $('#SubmitResults').hide();
        $('#RefreshButton').hide();
        $('#OopsButton').hide();
        $('#RerunTable').show();
        
        try
        {
            // Get the Cookie data
            var dbID = getCookie("KubKarsScoutTrucks_dbID");
            var nmPerson = getCurrentUserId().then(userId => {
                              if (userId) {
                                console.log(`Logged in user’s ID: ${userId}`);
                              } else {
                                console.log('No user ID available');
                              }
                           });
            var HeatID = getCookie("KubKarsScoutTrucks_HeatID");
            var RaceType = getCookie("KubKarsScoutTrucks_RaceType");
            var RaceTypeTxt = getCookie("KubKarsScoutTrucks_RaceTypeTxt");
            var Signature = htmlEncode(CleanseSignatureText(nmPerson));
            
            // dbID must be a 1 or 2
            if (dbID == 1 || dbID == 2) {
                TrackID = document.getElementById('frmTrackInput').value;
                // Change data source based on cookie, and update the Section based on the cookie
                if (dbID == 1) {
                    if (RaceType == 1) {
                        var LatestFinishedURL = window.location.origin + '/api/cubs/latest_finished_heats/' + TrackID;
                    }
                    if (RaceType == 2) {
                        var LatestFinishedURL = window.location.origin + '/api/cubs/latest_finished_runoffs/' + TrackID;
                    }
                    var UnlockURL = window.location.origin + '/api/cubs/unlockrace/' + RaceType;
                }
                if (dbID == 2) {
                    if (RaceType == 1) {
                        var LatestFinishedURL = window.location.origin + '/api/scouts/latest_finished_heats/' + TrackID;
                    }
                    if (RaceType == 2) {
                        var LatestFinishedURL = window.location.origin + '/api/scouts/latest_finished_runoffs/' + TrackID;
                    }
                    var UnlockURL = window.location.origin + '/api/scouts/unlockrace/' + RaceType;
                }
                fetchAndShowReruns(LatestFinishedURL,UnlockURL,RaceTypeTxt,Signature);
            }
        }
        catch (error) 
        {
            // draw an alert box with the error visible
            showAlert(['<div class="alert alert-danger fade show" role="alert">',
                       '  <strong>Ooops!</strong> There was an error during data processing. You can try doing it again, or <a href="recording.html" class="alert-link">Reload Page</a>',
                       error,
                       '</div>']);
        }
        
    }
    
    
    function HidePotentialReruns() {
    
        // Goes back to the standard view, refreshes the data
        $('#RerunTable').hide();
        $('#TrackSummary').show();
        $('#CurrentRace').show();
        $('#CurrentRaceResults').show();
        $('#SubmitResults').show();
        $('#RefreshButton').show();
        $('#OopsButton').show();
        refreshTrackData();
    }
    
    $(document).ready(function() 
    {
        
        // Add an event listener to look for changes to the selection of track
        document.getElementById("frmTrackInput").addEventListener("change", refreshTrackData);
        
        // Hide the Track Content until the user selects a track
        $('#TrackContent').hide();
        // Hide the reruns until someone presses the button to show them
        $('#RerunTable').hide();
        
        // Get the Cookie data
        var dbID = getCookie("KubKarsScoutTrucks_dbID");
        var nmPerson = getCookie("KubKarsScoutTrucks_name");
        
        // Put the Name on the grid
        document.getElementById('nmPersonCell').innerHTML = htmlEncode(nmPerson);
        
        // dbID must be a 1 or 2
        if (dbID == 1 || dbID == 2) {
        
            // Change data source based on cookie, and update the Section based on the cookie
            if (dbID == 1) {
                document.getElementById('SectionCell').innerHTML = htmlEncode('Cubs');
                document.getElementById('MainHeader').innerHTML = htmlEncode('Kub Kars - Recording');
                var TracksUrl = window.location.origin + '/api/cubs/tracks';
                var VehiclesPerHeatURL = window.location.origin + '/api/cubs/vehicles_per_heat';
            }
            if (dbID == 2) {
                document.getElementById('SectionCell').innerHTML = htmlEncode('Scouts');
                document.getElementById('MainHeader').innerHTML = htmlEncode('Scout Trucks - Recording');
                var TracksUrl = window.location.origin + '/api/scouts/tracks';
                var VehiclesPerHeatURL = window.location.origin + '/api/scouts/vehicles_per_heat';
            }
            
            try {
                // Put those Track Ids in the select dropdown.
                // Call the function to populate the Track List
                fetchDataAndPopulateDropdown(TracksUrl);
                // The page from now on responds to user input
            } catch (error) {
                // draw an alert box with the error visible
                showAlert(['<div class="alert alert-danger fade show" role="alert">',
                           '  <strong>Ooops!</strong> There was an error during retrieval of data. <a href="recording.html" class="alert-link">Reload Page</a>',
                           error,
                           '</div>']);
            }
            
        } else {
          
          // Show the alert
          showAlert(['<div class="alert alert-danger fade show" role="alert">',
                     '  <strong>Ooops!</strong> There was an error when setting/checking cookies. <a href="index.html" class="alert-link">Start Over</a>',
                     '</div>']);
        }

    });
 
  </script>
  
</head>

<body>

  <!-- Temporary Modal box, shows up after pressing Save Results -->
  <div class="modal" id="ErrorBox">
    <div class="modal-dialog">
      <div class="modal-content">
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title" id="ModalTitle"></h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <!-- Modal body -->
        <div class="modal-body" id="ErrorBoxText">
        </div>
        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="modalbutton">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Offcanvas Sidebar -->
  <div class="offcanvas offcanvas-start" id="RoleSwitcher">
    <div class="offcanvas-header">
      <h1 class="offcanvas-title">Switch Role</h1>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <p>Choose a role to switch to, or start again:</p>
      <p>
      <a href="/kubkars" class="btn btn-primary">Start Over</a>
      <p>
      <a href="/setting_up" class="btn btn-primary">Setting Up</a> 
      <p>
      <a href="/recording" class="btn btn-primary">Recording</a> 
      <p>
      <a href="/monitoring" class="btn btn-primary">Monitoring</a> 
      <p>
    </div>
  </div>

  <div class="container-fluid p-5 bg-warning text-black text-center">
    <h1 id="MainHeader"></h1>
    <!-- Button to open the offcanvas sidebar -->
    <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#RoleSwitcher">Switch Role</button> 
  </div>
  
  <!-- Container for any alerts -->
  <div id="liveAlertPlaceholder"></div>
  
  <!-- Main Page Container -->
  <div class="container-fluid p-5 bg-white text-black text-center" id="mainPageContent">
  
    <!-- Info Box -->
    <div class="container-fluid">
      <div class="row justify-content-center">
        <div class="col border bg-light text-end"><strong>Section:</strong></div>
        <div class="col border" id='SectionCell'></div>
      </div>
      <div class="row justify-content-center">
        <div class="col border bg-light text-end"><strong>Name:</strong></div>
        <div class="col border" id='nmPersonCell'></div>
      </div>
    </div>
    <br>
    <!-- Selector for Track -->
    <br>
    <h4>Select Track:</h4>
    <select class="form-select" id="frmTrackInput" required>
      <option value="default" selected>Choose Track...</option>
    </select>
    <br>
    <!-- A Refresh Data Button -->
    <button type="button" class="btn btn-primary" onclick="refreshTrackData()" id="RefreshButton">Refresh</button>
    <br>
    <!-- Track Data -->
    <br>
    <div class="container" id="TrackContent">
      
      <!-- A heat summary at the top of the page -->
      <div id="TrackSummary">
        <div id="HeatSummary">
          <h4>Heats</h4>
          <div class="container-fluid">
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Total:</strong></div><div class="col border" id='statTotalHeats'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Finished:</strong></div><div class="col border" id='statFinishedHeats'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Unfinished:</strong></div><div class="col border" id='statUnfinishedHeats'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>% Complete:</strong></div><div class="col border" id='statHeatPercentComplete'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Current Heat:</strong></div><div class="col border" id='statCurrentHeat'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Next Heat:</strong></div><div class="col border" id='statNextHeat'></div>
            </div>
          </div>
        </div>
        <div id="RunOffSummary">
          <h4>Run-Offs</h4>
          <div class="container-fluid">
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Total RunOffs:</strong></div><div class="col border" id='statTotalRunOffs'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Finished:</strong></div><div class="col border" id='statFinishedRunOffs'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Unfinished:</strong></div><div class="col border" id='statUnfinishedRunOffs'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>% Complete:</strong></div><div class="col border" id='statROPercentComplete'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Current RunOff:</strong></div><div class="col border" id='statCurrentRunOff'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Next RunOff:</strong></div><div class="col border" id='statNextRunOff'></div>
            </div>
          </div>
          <br>
        </div>
      </div>
      
      <!-- Current Heat -->
      <!-- Not all lanes will be shown, depends on Vehicles Per Heat setting. -->
      <div id="CurrentRace">
        <h4>Current Race & Lane Info:</h4>
        <div class="container-fluid">
          <div class="row justify-content-center">
            <div class="col border bg-light text-end"><strong>Race Type:</strong></div><div class="col border" id='CurRaceType'></div>
          </div>
          <div class="row justify-content-center">
            <div class="col border bg-light text-end"><strong>Race #:</strong></div><div class="col border" id='CurRaceNum'></div>
          </div>
          <div class="row justify-content-center" id="CurLane1Row">
            <div class="col border bg-light text-end"><strong>Lane 1:</strong></div><div class="col border" id='CurLane1CarID'></div>
          </div>
          <div class="row justify-content-center" id="CurLane2Row">
            <div class="col border bg-light text-end"><strong>Lane 2:</strong></div><div class="col border" id='CurLane2CarID'></div>
          </div>
          <div class="row justify-content-center" id="CurLane3Row">
            <div class="col border bg-light text-end"><strong>Lane 3:</strong></div><div class="col border" id='CurLane3CarID'></div>
          </div>
          <div class="row justify-content-center" id="CurLane4Row">
            <div class="col border bg-light text-end"><strong>Lane 4:</strong></div><div class="col border" id='CurLane4CarID'></div>
          </div>
          <div class="row justify-content-center" id="CurLane5Row">
            <div class="col border bg-light text-end"><strong>Lane 5:</strong></div><div class="col border" id='CurLane5CarID'></div>
          </div>
          <div class="row justify-content-center" id="CurLane6Row">
            <div class="col border bg-light text-end"><strong>Lane 6:</strong></div><div class="col border" id='CurLane6CarID'></div>
          </div>
        </div>
        <br>
      </div>
      
      <div id="CurrentRaceResults">
        <h4>Race Results:</h4>
        <div class="container-fluid">
          <div class="row justify-content-center" id="CurLane1ResultRow">
            <div class="col border bg-light text-end"><strong>Lane 1:</strong></div><div class="col border" id='CurLane1Result'><select class="form-select form-select-sm" id="CurLane1ResultSelect"></select></div>
          </div>
          <div class="row justify-content-center" id="CurLane2ResultRow">
            <div class="col border bg-light text-end"><strong>Lane 2:</strong></div><div class="col border" id='CurLane2Result'><select class="form-select form-select-sm" id="CurLane2ResultSelect"></select></div>
          </div>
          <div class="row justify-content-center" id="CurLane3ResultRow">
            <div class="col border bg-light text-end"><strong>Lane 3:</strong></div><div class="col border" id='CurLane3Result'><select class="form-select form-select-sm" id="CurLane3ResultSelect"></select></div>
          </div>
          <div class="row justify-content-center" id="CurLane4ResultRow">
            <div class="col border bg-light text-end"><strong>Lane 4:</strong></div><div class="col border" id='CurLane4Result'><select class="form-select form-select-sm" id="CurLane4ResultSelect"></select></div>
          </div>
          <div class="row justify-content-center" id="CurLane5ResultRow">
            <div class="col border bg-light text-end"><strong>Lane 5:</strong></div><div class="col border" id='CurLane5Result'><select class="form-select form-select-sm" id="CurLane5ResultSelect"></select></div>
          </div>
          <div class="row justify-content-center" id="CurLane6ResultRow">
            <div class="col border bg-light text-end"><strong>Lane 6:</strong></div><div class="col border" id='CurLane6Result'><select class="form-select form-select-sm" id="CurLane6ResultSelect"></select></div>
          </div>
        </div>
      </div>
      
      <!-- Recording the results is done by the user clicking a button -->
      <!-- Verify they selected the right positions, no ties -->
      <!-- Confirm submission -->
      <br>
      <div id="SubmitResults">
        <!-- A Save Results Button -->
        <button type="button" class="btn btn-primary" onclick="CallSaveResults()">Save Results</button>
      </div>

      <div id="Rerun">
        <br>
        <hr>
        <br>
        <!-- Here we provide a way for someone to undo a result  -->
        <button type="button" class="btn btn-primary" onclick="ShowPotentialReruns()" id="OopsButton">Ooops! I need to rerun a race!</button>
        
        <!-- Table of the last 5 races; Mixing of RunOffs and Heats is not possible -->
        <!-- Hidden until someone presses the button -->
        <div id="RerunTable">
          <div class="container-fluid">
            <div class="row justify-content-center" id="RerunRow1">
              <div class="col border bg-light text-end" id="RR1_1"></div><div class="col border" id='RR1_2'></div>
            </div>
            <div class="row justify-content-center" id="RerunRow2">
              <div class="col border bg-light text-end" id="RR2_1"></div><div class="col border" id='RR2_2'></div>
            </div>
            <div class="row justify-content-center" id="RerunRow3">
              <div class="col border bg-light text-end" id="RR3_1"></div><div class="col border" id='RR3_2'></div>
            </div>
            <div class="row justify-content-center" id="RerunRow4">
              <div class="col border bg-light text-end" id="RR4_1"></div><div class="col border" id='RR4_2'></div>
            </div>
            <div class="row justify-content-center" id="RerunRow5">
              <div class="col border bg-light text-end" id="RR5_1"></div><div class="col border" id='RR5_2'></div>
            </div>
          </div>
          <br>
          <button type="button" class="btn btn-primary" onclick="HidePotentialReruns()">Click here when done unlocking</button>
        </div>
      </div>
      
      <!-- A Hidden div, shown when all races are finished -->
      <div id="AllRacesComplete">
        <h3>Racing Finished!</h3>
      </div>
      
    </div>

  </div>
  
</body>
</html>