<!DOCTYPE html>
<html lang="en-CA">
<head>
  <meta charset="utf-8">
  <title>Kub Kars and Scout Trucks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/libs/bootstrap-5.3.3-dist/css/bootstrap.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="/assets/images/Scouts-Badge.png">
  <script src="/libs/jquery-3.7.1.min.js" type="application/javascript"></script>
  <script src="/libs/bootstrap-5.3.3-dist/js/bootstrap.js" type="application/javascript"></script>
  <script src="/libs/popper.min.js" type="application/javascript"></script>
  <script src="/libs/common.js" type="application/javascript"></script>
  
  <script>
    
    var isOpen = false;
    
    // I'm aware that I mix JQuery calls with JavaScript here, notably things like:
    // 
    // $('#xxx).hide();
    // and 
    // document.getElementById(xxx)
    //
    // And that ideally, we would not want to mix them. 
    // 
    // Well, I tried using the style.display instead of show(), hide(). All my layouts pooched. Screw that. I gave up. 
    // Why bother? One line. Thats it.
    // I'll live with it. 
    // 
    // :-)
    //
    
    // A function to try and auto-select a position based on the selections already in place.
    
    function finishSelection()
    {
        
        // Possible positions always get added to Select 1:
        var vphPossibles = [];
        var sel = document.getElementById('CurLane1ResultSelect').options;
        
        for (var i=0, n=sel.length;i<n;i++) 
        {
             // Since we only have 6 tracks, there's only a certain number of possible values we need to check
             // so just hardcode it.
             if ( sel[i].value == "1" || sel[i].value == "2" || sel[i].value == "3" || sel[i].value == "4" || sel[i].value == "5" || sel[i].value == "6" )
             {
                  vphPossibles.push(parseInt(sel[i].value));
             }
        }
        
        // These Sn values are the values that the user selected
        // If "default", 0 is used.
        s1 = parseInt(document.getElementById('CurLane1ResultSelect').value) || 0;
        s2 = parseInt(document.getElementById('CurLane2ResultSelect').value) || 0;
        s3 = parseInt(document.getElementById('CurLane3ResultSelect').value) || 0;
        s4 = parseInt(document.getElementById('CurLane4ResultSelect').value) || 0;
        s5 = parseInt(document.getElementById('CurLane5ResultSelect').value) || 0;
        s6 = parseInt(document.getElementById('CurLane6ResultSelect').value) || 0;
        
        var dnr_cnt = 0;
        var pos_cnt = 0;
        var vph = 0;
        var max_pos = 0;
        
        // pos_cnt is the number of actual positions chosen
        pos_cnt = (s1 + s2 + s3 + s4 + s5 + s6)  % 1000;
        // dnr_cnt is the number of DNRs chosen
        dnr_cnt = Math.round((s1 + s2 + s3 + s4 + s5 + s6) / 1000);
        // Vehicles Per Heat is the length of the array
        vph = vphPossibles.length;
        // Max position that can be chosen is the vph minus the DNRs
        max_pos = vph - dnr_cnt;
        // Remove positions greater than the max
        vphPossibles.splice(max_pos);
        
        // If s1 is a real position, remove
        if (s1 >= 1 && s1 <= 6)
        {
            if (vphPossibles.indexOf(s1) > -1)
            {
                vphPossibles.splice(vphPossibles.indexOf(s1), 1);
            }
        }
        
        // If s2 is a real position, remove 
        if (s2 >= 1 && s2 <= 6)
        {
            if (vphPossibles.indexOf(s2) > -1)
            {
                vphPossibles.splice(vphPossibles.indexOf(s2), 1);
            }
        }
        
        // If s3 is a real position, remove 
        if (s3 >= 1 && s3 <= 6)
        {
            if (vphPossibles.indexOf(s3) > -1)
            {
                vphPossibles.splice(vphPossibles.indexOf(s3), 1);
            }
        }
        
        // If s4 is a real position, remove 
        if (s4 >= 1 && s4 <= 6)
        {
            if (vphPossibles.indexOf(s4) > -1)
            {
                vphPossibles.splice(vphPossibles.indexOf(s4), 1);
            }
        }
        
        // If s5 is a real position, remove 
        if (s5 >= 1 && s5 <= 6)
        {
            if (vphPossibles.indexOf(s5) > -1)
            {
                vphPossibles.splice(vphPossibles.indexOf(s5), 1);
            }
        }
        
        // If s6 is a real position, remove 
        if (s6 >= 1 && s6 <= 6)
        {
            if (vphPossibles.indexOf(s6) > -1)
            {
                vphPossibles.splice(vphPossibles.indexOf(s6), 1);
            }
        }
        
        // If the remaining size of vphPossibles is 0, then it contains the final position to choose.
        if ( vphPossibles.length === 1 )
        {
             // This will only select a position if none has been selected
             if ( s1 == 0 ) {
                  document.getElementById('CurLane1ResultSelect').value = vphPossibles[0]
             } 
             else
             if ( s2 == 0 ) {
                  document.getElementById('CurLane2ResultSelect').value = vphPossibles[0]
             } 
             else
             if ( s3 == 0 ) {
                  document.getElementById('CurLane3ResultSelect').value = vphPossibles[0]
             } 
             else
             if ( s4 == 0 ) {
                  document.getElementById('CurLane4ResultSelect').value = vphPossibles[0]
             } 
             else
             if ( s5 == 0 ) {
                  document.getElementById('CurLane5ResultSelect').value = vphPossibles[0]
             } 
             else
             if ( s6 == 0 ) {
                  document.getElementById('CurLane6ResultSelect').value = vphPossibles[0]
             } 
        }
        
    }
    
    // A function to show an alert when there is an error
    function showAlert(CustomInnerHTML) 
    {
        const alertPlaceholder = document.getElementById('liveAlertPlaceholder');
        const appendAlert = () => 
        {
            const wrapper = document.createElement('div');
            wrapper.innerHTML = [CustomInnerHTML].join('');
            alertPlaceholder.append(wrapper);
        }
        appendAlert();
    }
    
    function ShowTrackSelector()
    {
        // Returns TRUE when the div is showing
        $('#TrackSelector').show();
        // Change the text of the track switch button
        document.getElementById('SwitchTracksButton').textContent = 'Hide Track Switcher';
    }
    
    function HideTrackSelector()
    {
        // Returns TRUE when the div is showing
        $('#TrackSelector').hide();
        // Change the text of the track switch button
        document.getElementById('SwitchTracksButton').textContent = 'Switch Tracks';
    }
    
    function ShowHideTrackSelector()
    {
        // If hidden, show it, and vice-versa.
        
        if (document.getElementById('TrackSelector').checkVisibility() )
        {
            HideTrackSelector();
        }
        else
        {
            ShowTrackSelector();
        }
    }
    
    function CleanseSignatureText(input) 
    {
        if (typeof input !== 'string') 
        {
            return input; // If it's not a string, return as is
        }
    
        // Escape characters that could be used for SQL injection
        return input
            .replace(/[^a-zA-Z0-9]/g, "")  // Remove non-alphanumeric characters
            .replace(/\s/g, '')            // Remove spaces
            .replace(/'/g, '')             // Remove quotes
            .replace(/"/g, '')             // Remove double quotes
            .replace(/;/g, '')             // Remove semicolons
            .replace(/--/g, '')            // Remove SQL comments
            .replace(/\\/g, '')            // Remove backslashes
            .replace(/[\n\r]/g, '');       // Remove newline characters
    }
    
    // A function to call the API to put the Track IDs in the dropdown
    async function fetchDataAndPopulateDropdown(apiurl)
    {
        try
        {
            const response = await fetch(apiurl);
            if (!response.ok)
            {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const data = await response.json();
            const dropdown = document.getElementById('frmTrackInput');
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.track;
                option.textContent = item.track;
                dropdown.appendChild(option);
            });
        } 
        catch (error)
        {
            showAlert('<div class="alert alert-danger alert-dismissible" role="alert">' +
                      '  <strong>Ooops!</strong> There was an error during retrieval of data. <a href="javascript:;" onclick="reload()" class="alert-link">Reload Page</a> OR <a href="/kubkars" class="alert-link">Start Again</a>. Error Text: ' +
                      error +
                      '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                      '</div>');
        }
    }
    
    // A function to update the summary data for the selected track
    // data[0] is used because the summary ALWAYS returns ONE record.
    
    async function fetchAndPopulateRaceAndSummary(TrackSummaryURL,RaceURL,VehiclesPerHeatURL)
    {
        // A function to add the Ordinal positions to the Result Selection
        
        function addOptionsToSelect(count, selectElementId) 
        {
            // Get the select element by its id
            const selectElement = document.getElementById(selectElementId);

            // Clear all existing options
            selectElement.innerHTML = "";
            
            // Add a placeholder option with no selection
            const placeholderOption = document.createElement("option");
            placeholderOption.value = "default";
            placeholderOption.text = "Select Position";
            placeholderOption.disabled = true; // Prevent the placeholder from being selected
            placeholderOption.selected = true; // Ensure it's selected by default
            selectElement.appendChild(placeholderOption);
            
            // Add a "Did Not Race" option
            const DNROption = document.createElement("option");
            DNROption.value = "1000";
            DNROption.text = "Did Not Race";
            DNROption.disabled = false; // It can be selected
            DNROption.selected = false; // It's not selected by default
            selectElement.appendChild(DNROption);
            
            // Helper function to convert a number to its ordinal form
            function getOrdinal(num) 
            {
                const suffixes = ["th", "st", "nd", "rd"];
                const remainder = num % 100;
                return num + (suffixes[(remainder - 20) % 10] || suffixes[remainder] || suffixes[0]);
            }
            
            // Add the required number of new options
            for (let i = 1; i <= count; i++) 
            {
                // Create a new option element
                const option = document.createElement("option");
                option.value = `${i}`;
                option.text = getOrdinal(i); // Set the text as the ordinal of i
                
                // Add the option to the select element
                selectElement.appendChild(option);
            }
        }
        
        try
        {
            const vph_response = await fetch(VehiclesPerHeatURL);
            if (!vph_response.ok)
            {
                throw new Error(`HTTP error! Status: ${vph_response.status}`);
            }
            const vph_data = await vph_response.json();
            var vehicles_per_heat = vph_data[0].VehiclesPerHeat;
            
            // Vehicles Per Heat now determines the positions available in the Results Area
            // if VPH = 2, there can only be 1st and 2nd.
            // if VPH = 3, there can only be 1st, 2nd, 3rd
            // etc
            // Clear the options from all SELECTs
            // Based on VPH, these will be repopulated shortly.
            document.getElementById('CurLane1ResultSelect').innerHTML = "";
            document.getElementById('CurLane2ResultSelect').innerHTML = "";
            document.getElementById('CurLane3ResultSelect').innerHTML = "";
            document.getElementById('CurLane4ResultSelect').innerHTML = "";
            document.getElementById('CurLane5ResultSelect').innerHTML = "";
            document.getElementById('CurLane6ResultSelect').innerHTML = "";
            
            const t_response = await fetch(TrackSummaryURL);
            if (!t_response.ok) 
            {
                throw new Error(`HTTP error! Status: ${t_response.status}`);
            }
            const t_data = await t_response.json();
            
            // Heat Summary
            document.getElementById('statHeatPercentComplete').innerHTML = htmlEncode(t_data[0].heats_pct_complete);
            document.getElementById('statTotalHeats').innerHTML = htmlEncode(t_data[0].total_heat_count);
            document.getElementById('statFinishedHeats').innerHTML = htmlEncode(t_data[0].finished_heats);
            document.getElementById('statUnfinishedHeats').innerHTML = htmlEncode(t_data[0].unfinished_heats);
            document.getElementById('statCurrentHeat').innerHTML = htmlEncode(t_data[0].current_heat);
            document.getElementById('statNextHeat').innerHTML = htmlEncode(t_data[0].next_heat);
            // Runoff Summary
            document.getElementById('statTotalRunOffs').innerHTML = htmlEncode(t_data[0].total_runoff_count);
            document.getElementById('statFinishedRunOffs').innerHTML = htmlEncode(t_data[0].finished_runoffs);
            document.getElementById('statUnfinishedRunOffs').innerHTML = htmlEncode(t_data[0].unfinished_runoffs);
            document.getElementById('statROPercentComplete').innerHTML = htmlEncode(t_data[0].runoffs_pct_complete);
            document.getElementById('statCurrentRunOff').innerHTML = htmlEncode(t_data[0].current_runoff);
            document.getElementById('statNextRunOff').innerHTML = htmlEncode(t_data[0].next_runoff);
            
            // TODO: Images or Colours for visibility?
            
            
            // Show the heats if they are not finished
            if ( parseFloat(t_data[0].heats_pct_complete) < 100 && parseFloat(t_data[0].heats_pct_complete) >= 0 )
            {
                
                // Hide the "Races Complete" div
                $('#AllRacesComplete').hide();
                // Show the Heats, hide the run-offs (not started)
                $('#HeatSummary').show();
                $('#RunOffSummary').hide();
                
                // Current Race Updates:
                document.getElementById('CurRaceNum').innerHTML = htmlEncode(t_data[0].current_heat);
                document.getElementById('CurRaceType').innerHTML = 'Heat';
                
                // Save Values
                sessionStorage.setItem("KubKarsScoutTrucks_RaceType",1);
                sessionStorage.setItem("KubKarsScoutTrucks_RaceTypeTxt",'Heat');
                sessionStorage.setItem('KubKarsScoutTrucks_HeatID',htmlEncode(t_data[0].current_heat));
                
                // There's probably a nicer way of doing this, but this works.
                
                // Hide them all
                $('#CurLane1Row').hide();
                $('#CurLane2Row').hide();
                $('#CurLane3Row').hide();
                $('#CurLane4Row').hide();
                $('#CurLane5Row').hide();
                $('#CurLane6Row').hide();
                // Result rows get hidden too
                $('#CurLane1ResultRow').hide();
                $('#CurLane2ResultRow').hide();
                $('#CurLane3ResultRow').hide();
                $('#CurLane4ResultRow').hide();
                $('#CurLane5ResultRow').hide();
                $('#CurLane6ResultRow').hide();
                
                // Current Heat Data
                const ch_response = await fetch(RaceURL + '/' + t_data[0].current_heat + '/1');
                if (!ch_response.ok) 
                {
                    throw new Error(`HTTP error! Status: ${ch_response.status}`);
                }
                const ch_data = await ch_response.json();
                
                // Show them based on the vehicles_per_heat setting
                
                if ( vehicles_per_heat == 6 ) 
                {
                    addOptionsToSelect(vehicles_per_heat,'CurLane6ResultSelect');
                    if ( ch_data[0].lane6_carNumber == -1 )
                    {
                        document.getElementById('CurLane6CarID').innerHTML = 'No Racer';
                        document.getElementById('CurLane6CarIDNum').innerHTML = 'NA';
                        // Select Did Not Race automatically
                        document.getElementById('CurLane6ResultSelect').value = 1000;
                    }
                    else
                    {
                        document.getElementById('CurLane6CarID').innerHTML = htmlEncode(ch_data[0].lane6_carNumber + ' - ' + ch_data[0].lane6_driver + ' (' + ch_data[0].lane6_group + ')');
                        document.getElementById('CurLane6CarIDNum').innerHTML = htmlEncode(ch_data[0].lane6_carNumber);
                    }
                    $('#CurLane6Row').show();
                    $('#CurLane6ResultRow').show();
                }
                
                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 ) 
                {
                    addOptionsToSelect(vehicles_per_heat,'CurLane5ResultSelect');
                    if ( ch_data[0].lane5_carNumber == -1 )
                    {
                        document.getElementById('CurLane5CarID').innerHTML = 'No Racer';
                        document.getElementById('CurLane5CarIDNum').innerHTML = 'NA';
                        // Select Did Not Race automatically
                        document.getElementById('CurLane5ResultSelect').value = 1000;
                    }
                    else
                    {
                        document.getElementById('CurLane5CarID').innerHTML = htmlEncode(ch_data[0].lane5_carNumber + ' - ' + ch_data[0].lane5_driver + ' (' + ch_data[0].lane5_group + ')');
                        document.getElementById('CurLane5CarIDNum').innerHTML = htmlEncode(ch_data[0].lane5_carNumber);
                    }
                    $('#CurLane5Row').show();
                    $('#CurLane5ResultRow').show();
                }
                
                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 ) 
                {
                    addOptionsToSelect(vehicles_per_heat,'CurLane4ResultSelect');
                    if ( ch_data[0].lane4_carNumber == -1 )
                    {
                        document.getElementById('CurLane4CarID').innerHTML = 'No Racer';
                        document.getElementById('CurLane4CarIDNum').innerHTML = 'NA';
                        // Select Did Not Race automatically
                        document.getElementById('CurLane4ResultSelect').value = 1000;
                    }
                    else
                    {
                        document.getElementById('CurLane4CarID').innerHTML = htmlEncode(ch_data[0].lane4_carNumber + ' - ' + ch_data[0].lane4_driver + ' (' + ch_data[0].lane4_group + ')');
                        document.getElementById('CurLane4CarIDNum').innerHTML = htmlEncode(ch_data[0].lane4_carNumber);
                    
                    }
                    $('#CurLane4Row').show();
                    $('#CurLane4ResultRow').show();
                }

                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 ) 
                {
                    addOptionsToSelect(vehicles_per_heat,'CurLane3ResultSelect');
                    if ( ch_data[0].lane3_carNumber == -1 )
                    {
                        document.getElementById('CurLane3CarID').innerHTML = 'No Racer';
                        document.getElementById('CurLane3CarIDNum').innerHTML = 'NA';
                        // Select Did Not Race automatically
                        document.getElementById('CurLane3ResultSelect').value = 1000;
                    }
                    else
                    {
                        document.getElementById('CurLane3CarID').innerHTML = htmlEncode(ch_data[0].lane3_carNumber + ' - ' + ch_data[0].lane3_driver + ' (' + ch_data[0].lane3_group + ')');
                        document.getElementById('CurLane3CarIDNum').innerHTML = htmlEncode(ch_data[0].lane3_carNumber);
                    }
                    $('#CurLane3Row').show();
                    $('#CurLane3ResultRow').show();
                }

                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 || vehicles_per_heat == 2 ) 
                {
                    addOptionsToSelect(vehicles_per_heat,"CurLane2ResultSelect");
                    addOptionsToSelect(vehicles_per_heat,'CurLane1ResultSelect');
                    
                    if ( ch_data[0].lane2_carNumber == -1 )
                    {
                        document.getElementById('CurLane2CarID').innerHTML = 'No Racer';
                        document.getElementById('CurLane2CarIDNum').innerHTML = 'NA';
                        // Select Did Not Race automatically
                        document.getElementById('CurLane2ResultSelect').value = 1000;
                    }
                    else
                    {
                        document.getElementById('CurLane2CarID').innerHTML = htmlEncode(ch_data[0].lane2_carNumber + ' - ' + ch_data[0].lane2_driver + ' (' + ch_data[0].lane2_group + ')');
                        document.getElementById('CurLane2CarIDNum').innerHTML = htmlEncode(ch_data[0].lane2_carNumber);
                    }
                    $('#CurLane2Row').show();
                    $('#CurLane2ResultRow').show();

                    if ( ch_data[0].lane1_carNumber == -1 )
                    {
                        document.getElementById('CurLane1CarID').innerHTML = 'No Racer';
                        document.getElementById('CurLane1CarIDNum').innerHTML = 'NA';
                        // Select Did Not Race automatically
                        document.getElementById('CurLane1ResultSelect').value = 1000;
                    }
                    else
                    {
                        document.getElementById('CurLane1CarID').innerHTML = htmlEncode(ch_data[0].lane1_carNumber + ' - ' + ch_data[0].lane1_driver + ' (' + ch_data[0].lane1_group + ')');
                        document.getElementById('CurLane1CarIDNum').innerHTML = htmlEncode(ch_data[0].lane1_carNumber);
                    }
                    $('#CurLane1Row').show();
                    $('#CurLane1ResultRow').show();
                }
                
                // Show Current Race
                $('#CurrentRace').show();
                $('#CurrentRaceResults').show();
                $('#SubmitResults').show();
                $('#Rerun').show();
            }
            // Hide the heats and show the runoffs if these are incomplete
            else if ( parseFloat(t_data[0].heats_pct_complete) == 100 && parseFloat(t_data[0].runoffs_pct_complete) < 100 && parseFloat(t_data[0].runoffs_pct_complete) >= 0 )
            {
                // Hide the "Races Complete" div
                $('#AllRacesComplete').hide();
                // Hide the heats
                $('#HeatSummary').hide();
                // Show the Run Offs
                $('#RunOffSummary').show();
                
                // Current Race Updates:
                document.getElementById('CurRaceNum').innerHTML = htmlEncode(t_data[0].current_runoff);
                document.getElementById('CurRaceType').innerHTML = 'RunOff';
                
                // Save values
                sessionStorage.setItem("KubKarsScoutTrucks_RaceType",2);
                sessionStorage.setItem("KubKarsScoutTrucks_RaceTypeTxt",'RunOff');
                sessionStorage.setItem('KubKarsScoutTrucks_HeatID',htmlEncode(t_data[0].current_runoff));
                
                // There's probably a nicer way of doing this, but this works.
                // Hide them all
                $('#CurLane1Row').hide();
                $('#CurLane2Row').hide();
                $('#CurLane3Row').hide();
                $('#CurLane4Row').hide();
                $('#CurLane5Row').hide();
                $('#CurLane6Row').hide();
                
                $('#CurLane1ResultRow').hide();
                $('#CurLane2ResultRow').hide();
                $('#CurLane3ResultRow').hide();
                $('#CurLane4ResultRow').hide();
                $('#CurLane5ResultRow').hide();
                $('#CurLane6ResultRow').hide();
                
                // Current RunOff Data
                const cr_response = await fetch(RaceURL + '/' + t_data[0].current_runoff + '/2');
                if (!cr_response.ok) 
                {
                    throw new Error(`HTTP error! Status: ${cr_response.status}`);
                }
                const cr_data = await cr_response.json();
                
                // Show them based on the vehicles_per_heat setting
                if ( vehicles_per_heat == 6 ) 
                {
                    addOptionsToSelect(vehicles_per_heat,'CurLane6ResultSelect');
                    if ( cr_data[0].lane6_carNumber == -1 )
                    {
                        document.getElementById('CurLane6CarID').innerHTML = 'No Racer';
                        document.getElementById('CurLane6CarIDNum').innerHTML = 'NA';
                        // Select Did Not Race automatically
                        document.getElementById('CurLane6ResultSelect').value = 1000;
                    }
                    else
                    {
                        document.getElementById('CurLane6CarID').innerHTML = htmlEncode(cr_data[0].lane6_carNumber + ' - ' + cr_data[0].lane6_driver + ' (' + cr_data[0].lane6_group + ')');
                        document.getElementById('CurLane6CarIDNum').innerHTML = htmlEncode(cr_data[0].lane6_carNumber);
                    }
                    $('#CurLane6Row').show();
                    $('#CurLane6ResultRow').show();
                }
                
                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 ) 
                {
                    addOptionsToSelect(vehicles_per_heat,'CurLane5ResultSelect');
                    if ( cr_data[0].lane5_carNumber == -1 )
                    {
                        document.getElementById('CurLane5CarID').innerHTML = 'No Racer';
                        document.getElementById('CurLane5CarIDNum').innerHTML = 'NA';
                        // Select Did Not Race automatically
                        document.getElementById('CurLane5ResultSelect').value = 1000;
                    }
                    else
                    {
                        document.getElementById('CurLane5CarID').innerHTML = htmlEncode(cr_data[0].lane5_carNumber + ' - ' + cr_data[0].lane5_driver + ' (' + cr_data[0].lane5_group + ')');
                        document.getElementById('CurLane5CarIDNum').innerHTML = htmlEncode(cr_data[0].lane5_carNumber);
                    }
                    $('#CurLane5Row').show();
                    $('#CurLane5ResultRow').show();
                }
                
                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 ) 
                {
                    addOptionsToSelect(vehicles_per_heat,'CurLane4ResultSelect');
                    if ( cr_data[0].lane4_carNumber == -1 )
                    {
                        document.getElementById('CurLane4CarID').innerHTML = 'No Racer';
                        document.getElementById('CurLane4CarIDNum').innerHTML = 'NA';
                        // Select Did Not Race automatically
                        document.getElementById('CurLane4ResultSelect').value = 1000;
                    }
                    else
                    {
                        document.getElementById('CurLane4CarID').innerHTML = htmlEncode(cr_data[0].lane4_carNumber + ' - ' + cr_data[0].lane4_driver + ' (' + cr_data[0].lane4_group + ')');
                        document.getElementById('CurLane4CarIDNum').innerHTML = htmlEncode(cr_data[0].lane4_carNumber);
                    }
                    $('#CurLane4Row').show();
                    $('#CurLane4ResultRow').show();
                }

                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 ) 
                {
                    addOptionsToSelect(vehicles_per_heat,'CurLane3ResultSelect');
                    if ( cr_data[0].lane3_carNumber == -1 )
                    {
                        document.getElementById('CurLane3CarID').innerHTML = 'No Racer';
                        document.getElementById('CurLane3CarIDNum').innerHTML = 'NA';
                        // Select Did Not Race automatically
                        document.getElementById('CurLane3ResultSelect').value = 1000;
                    }
                    else
                    {
                        document.getElementById('CurLane3CarID').innerHTML = htmlEncode(cr_data[0].lane3_carNumber + ' - ' + cr_data[0].lane3_driver + ' (' + cr_data[0].lane3_group + ')');
                        document.getElementById('CurLane3CarIDNum').innerHTML = htmlEncode(cr_data[0].lane3_carNumber);
                    }
                    $('#CurLane3Row').show();
                    $('#CurLane3ResultRow').show();
                }

                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 || vehicles_per_heat == 2 ) 
                {
                    addOptionsToSelect(vehicles_per_heat,'CurLane2ResultSelect');
                    addOptionsToSelect(vehicles_per_heat,'CurLane1ResultSelect');
                    if ( cr_data[0].lane2_carNumber == -1 )
                    {
                        document.getElementById('CurLane2CarID').innerHTML = 'No Racer';
                        document.getElementById('CurLane2CarIDNum').innerHTML = 'NA';
                        // Select Did Not Race automatically
                        document.getElementById('CurLane2ResultSelect').value = 1000;
                    }
                    else
                    {
                        document.getElementById('CurLane2CarID').innerHTML = htmlEncode(cr_data[0].lane2_carNumber + ' - ' + cr_data[0].lane2_driver + ' (' + cr_data[0].lane2_group + ')');
                        document.getElementById('CurLane2CarIDNum').innerHTML = htmlEncode(cr_data[0].lane2_carNumber);
                    }
                    $('#CurLane2Row').show();
                    $('#CurLane2ResultRow').show();
                    if ( cr_data[0].lane1_carNumber == -1 )
                    {
                        document.getElementById('CurLane1CarID').innerHTML = 'No Racer';
                        document.getElementById('CurLane1CarIDNum').innerHTML = 'NA';
                        // Select Did Not Race automatically
                        document.getElementById('CurLane1ResultSelect').value = 1000;
                    }
                    else
                    {
                        document.getElementById('CurLane1CarID').innerHTML = htmlEncode(cr_data[0].lane1_carNumber + ' - ' + cr_data[0].lane1_driver + ' (' + cr_data[0].lane1_group + ')');
                        document.getElementById('CurLane1CarIDNum').innerHTML = htmlEncode(cr_data[0].lane1_carNumber);
                    }
                    $('#CurLane1Row').show();
                    $('#CurLane1ResultRow').show();
                }

                // Show Current Race & Results
                $('#CurrentRace').show();
                $('#CurrentRaceResults').show();
                $('#SubmitResults').show();
                $('#Rerun').show();
                
            }
            // Additional logic to add some visual aids (Complete/Incomplete)
            else if ( parseFloat(t_data[0].heats_pct_complete) == 100 && parseFloat(t_data[0].runoffs_pct_complete) == 100 )
            {
                // Unset data storage
                sessionStorage.removeItem("KubKarsScoutTrucks_RaceType");
                sessionStorage.removeItem("KubKarsScoutTrucks_RaceTypeTxt");
                sessionStorage.removeItem('KubKarsScoutTrucks_HeatID');

                // Hide everything not required
                $('#HeatSummary').hide();
                $('#RunOffSummary').hide();
                $('#CurrentRace').hide();
                $('#CurrentRaceResults').hide();
                $('#SubmitResults').hide();
                $('#Rerun').hide();
                // Show the "Races Complete" div
                $('#AllRacesComplete').show();
            }
        } 
        catch (error) 
        {
            showAlert('<div class="alert alert-danger alert-dismissible" role="alert">' +
                      '  <strong>Ooops!</strong> There was an error during retrieval of data. <a href="javascript:;" onclick="reload()" class="alert-link">Reload Page</a> OR <a href="/kubkars" class="alert-link">Start Again</a>. Error Text: ' +
                      error +
                      '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                      '</div>');
        }
    }

    async function refreshTrackData()
    {
        // item is the option that was selected, might be the default or an actual track id
        var item = document.getElementById("frmTrackInput").value;
        sessionStorage.setItem('KubKarsScoutTrucks_TrackID',document.getElementById("frmTrackInput").value);
        
        if (item == "default")
        {
            // Hide everything when the default option is selected
            $('#TrackContent').hide();
            $('#AllRacesComplete').hide();
        }
        else 
        {
            var dbID = sessionStorage.getItem("KubKarsScoutTrucks_dbID");
            // dbID must be 1 or 2
            if (dbID == 1 || dbID == 2) 
            {
                if (dbID == 1) 
                {
                    var TrackSummaryURL = window.location.origin + '/api/cubs/tracksummary/' + item;
                    var RaceURL = window.location.origin + '/api/cubs/race/' + item;
                    var VehiclesPerHeatURL = window.location.origin + '/api/cubs/vehicles_per_heat';
                }
                if (dbID == 2)
                {
                    var TrackSummaryURL = window.location.origin + '/api/scouts/tracksummary/' + item;
                    var RaceURL = window.location.origin + '/api/scouts/race/' + item;
                    var VehiclesPerHeatURL = window.location.origin + '/api/scouts/vehicles_per_heat';
                }
                // Show the Content
                $('#TrackContent').show();
                // Hide the track selector
                HideTrackSelector();
                // Refresh the summary and race data
                await fetchAndPopulateRaceAndSummary(TrackSummaryURL,RaceURL,VehiclesPerHeatURL);
                // Update TrackID span element
                document.getElementById('CurrentTrack').innerHTML = htmlEncode(item);
                
            }
        }
    }
    
    // This function gets called when refreshing the page every X seconds
    // We save what might have already been selected, refresh, then re-select.
    
    async function autoRefresh()
    {
        if (isOpen == false)
        {
            // Save any selected positions
            sessionStorage.setItem("CurLane1ResultSelect",document.getElementById("CurLane1ResultSelect").value);
            sessionStorage.setItem("CurLane2ResultSelect",document.getElementById("CurLane2ResultSelect").value);
            sessionStorage.setItem("CurLane3ResultSelect",document.getElementById("CurLane3ResultSelect").value);
            sessionStorage.setItem("CurLane4ResultSelect",document.getElementById("CurLane4ResultSelect").value);
            sessionStorage.setItem("CurLane5ResultSelect",document.getElementById("CurLane5ResultSelect").value);
            sessionStorage.setItem("CurLane6ResultSelect",document.getElementById("CurLane6ResultSelect").value);
            
            // Refresh the data
            await refreshTrackData();
            
            // Restore what was selected after the data refreshes
            document.getElementById("CurLane1ResultSelect").value = sessionStorage.getItem("CurLane1ResultSelect");
            document.getElementById("CurLane2ResultSelect").value = sessionStorage.getItem("CurLane2ResultSelect");
            document.getElementById("CurLane3ResultSelect").value = sessionStorage.getItem("CurLane3ResultSelect");
            document.getElementById("CurLane4ResultSelect").value = sessionStorage.getItem("CurLane4ResultSelect");
            document.getElementById("CurLane5ResultSelect").value = sessionStorage.getItem("CurLane5ResultSelect");
            document.getElementById("CurLane6ResultSelect").value = sessionStorage.getItem("CurLane6ResultSelect");
            
            // Remove the saved values
            sessionStorage.removeItem("CurLane1ResultSelect");
            sessionStorage.removeItem("CurLane2ResultSelect");
            sessionStorage.removeItem("CurLane3ResultSelect");
            sessionStorage.removeItem("CurLane4ResultSelect");
            sessionStorage.removeItem("CurLane5ResultSelect");
            sessionStorage.removeItem("CurLane6ResultSelect");
        }
    }
    
    async function SaveResults(VehiclesPerHeatURL,SaveResultsURL,Signature)
    {
        // This function gets called when the Save Results button is pressed
        // The job of this function is to check that the user filled in the results correctly
        // Check there are no ties
        // Call the API
        // Check the return code. The function should always complete successfully, but returns
        // an integer (usually a 0).
        // If it is anything other than 0, then there was a data error
        
        const vph_response = await fetch(VehiclesPerHeatURL);
        if (!vph_response.ok)
        {
            throw new Error(`HTTP error! Status: ${vph_response.status}`);
        }
        const vph_data = await vph_response.json();
        var vehicles_per_heat = vph_data[0].VehiclesPerHeat;
        
        // Check #1: Did the user make a selection for all boxes (depending on VPH):
        // The value of the position is just an integer, 1 thru VPH
        // The text shown in the dropdown is the ordinal (e.g. 1st, 2nd, etc)
        // Notice we don't use "else if"; because we want to check all applicable option selects
        
        const list = [1, 2, 3, 4, 5, 6, 1000];
        
        if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 || vehicles_per_heat == 2 ) 
        {
            if (!list.includes(parseInt(document.getElementById("CurLane1ResultSelect").value)) ) 
            {
                // Show Modal
                var element = document.getElementById("modalbutton");
                element.classList = "";
                element.classList.add("btn");
                element.classList.add("btn-danger");
                document.getElementById('ModalTitle').innerHTML = htmlEncode('Lane 1 missing');
                document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Position of Lane 1 is missing');
                $('#ErrorBox').modal('show');
                return false;
            }
            if (!list.includes(parseInt(document.getElementById("CurLane2ResultSelect").value)) ) 
            {
                // Show Modal
                var element = document.getElementById("modalbutton");
                element.classList = "";
                element.classList.add("btn");
                element.classList.add("btn-danger");
                document.getElementById('ModalTitle').innerHTML = htmlEncode('Lane 2 missing');
                document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Position of Lane 2 is missing');
                $('#ErrorBox').modal('show');
                return false;
            }
        }
        if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 ) 
        {
            if (!list.includes(parseInt(document.getElementById("CurLane3ResultSelect").value)) ) 
            {
                // Show Modal
                var element = document.getElementById("modalbutton");
                element.classList = "";
                element.classList.add("btn");
                element.classList.add("btn-danger");
                document.getElementById('ModalTitle').innerHTML = htmlEncode('Lane 3 missing');
                document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Position of Lane 3 is missing');
                $('#ErrorBox').modal('show');
                return false;
            }
        }
        if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 ) 
        {
            if (!list.includes(parseInt(document.getElementById("CurLane4ResultSelect").value)) ) 
            {
                // Show Modal
                var element = document.getElementById("modalbutton");
                element.classList = "";
                element.classList.add("btn");
                element.classList.add("btn-danger");
                document.getElementById('ModalTitle').innerHTML = htmlEncode('Lane 4 missing');
                document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Position of Lane 4 is missing');
                $('#ErrorBox').modal('show');
                return false;
            }
        }
        if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 ) 
        {
            if (!list.includes(parseInt(document.getElementById("CurLane5ResultSelect").value)) ) 
            {
                // Show Modal
                var element = document.getElementById("modalbutton");
                element.classList = "";
                element.classList.add("btn");
                element.classList.add("btn-danger");
                document.getElementById('ModalTitle').innerHTML = htmlEncode('Lane 5 missing');
                document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Position of Lane 5 is missing');
                $('#ErrorBox').modal('show');
                return false;
            }
        }
        if ( vehicles_per_heat == 6 ) 
        {
            if ( !list.includes(parseInt(document.getElementById("CurLane6ResultSelect").value)) ) 
            {
                // Show Modal
                var element = document.getElementById("modalbutton");
                element.classList = "";
                element.classList.add("btn");
                element.classList.add("btn-danger");
                document.getElementById('ModalTitle').innerHTML = htmlEncode('Lane 6 missing');
                document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Position of Lane 6 is missing');
                $('#ErrorBox').modal('show');
                return false;
            }
            
        }
        
        // User Selected List of Values
        const user_selected = []
        
        // The adjusted VPH is used to verify the max position if there are 1000's present.
        var adj_vph = vehicles_per_heat;
        
        // Some may be NULL depending on the VPH, so don't add the NaNs to the list.
        if (Number.isInteger(parseInt(document.getElementById("CurLane1ResultSelect").value))) 
        {
            if ( parseInt(document.getElementById("CurLane1ResultSelect").value) == 1000 ) 
            {
                adj_vph--;
            }
            else
            {
                user_selected.push(parseInt(document.getElementById("CurLane1ResultSelect").value));
            }
            aResult1 = document.getElementById("CurLane1ResultSelect").value;
        }
        else
        {
            aResult1 = 'null';
        }
        
        if (Number.isInteger(parseInt(document.getElementById("CurLane2ResultSelect").value))) 
        {
            if ( parseInt(document.getElementById("CurLane2ResultSelect").value) == 1000 ) 
            {
                adj_vph--;
            }
            else
            {
                user_selected.push(parseInt(document.getElementById("CurLane2ResultSelect").value));
            }
            aResult2 = document.getElementById("CurLane2ResultSelect").value;
        }
        else
        {
            aResult2 = 'null';
        }
        
        if (Number.isInteger(parseInt(document.getElementById("CurLane3ResultSelect").value))) 
        {
            if ( parseInt(document.getElementById("CurLane3ResultSelect").value) == 1000 ) 
            {
                adj_vph--;
            }
            else
            {
                user_selected.push(parseInt(document.getElementById("CurLane3ResultSelect").value));
            }
            aResult3 = document.getElementById("CurLane3ResultSelect").value;
        }
        else
        {
            aResult3 = 'null';
        }
        
        if (Number.isInteger(parseInt(document.getElementById("CurLane4ResultSelect").value))) 
        {
            if ( parseInt(document.getElementById("CurLane4ResultSelect").value) == 1000 ) 
            {
                adj_vph--;
            }
            else
            {
                user_selected.push(parseInt(document.getElementById("CurLane4ResultSelect").value));
            }
            aResult4 = document.getElementById("CurLane4ResultSelect").value;
        }
        else
        {
            aResult4 = 'null';
        }
        
        if (Number.isInteger(parseInt(document.getElementById("CurLane5ResultSelect").value))) 
        {
            if ( parseInt(document.getElementById("CurLane5ResultSelect").value) == 1000 ) 
            {
                adj_vph--;
            }
            else
            {
                user_selected.push(parseInt(document.getElementById("CurLane5ResultSelect").value));
            }
            aResult5 = document.getElementById("CurLane5ResultSelect").value;
        }
        else
        {
            aResult5 = 'null';
        }
        
        if (Number.isInteger(parseInt(document.getElementById("CurLane6ResultSelect").value))) 
        {
            if ( parseInt(document.getElementById("CurLane6ResultSelect").value) == 1000 ) 
            {
                adj_vph--;
            }
            else
            {
                user_selected.push(parseInt(document.getElementById("CurLane6ResultSelect").value));
            }
            aResult6 = document.getElementById("CurLane6ResultSelect").value;
        }
        else
        {
            aResult6 = 'null';
        }

        // Do the positions make sense? if VPH = 2, but one is 1000, did the other lane come 2nd? It should be 1st.
        // adj_vph should be the max position allowed. If there's a position greater, they need to re-enter.
        if ( Math.max(...user_selected) > adj_vph ) 
        {
            // Show Modal
            document.getElementById('ModalTitle').innerHTML = htmlEncode('Incorrect position selected');
            document.getElementById('ErrorBoxText').innerHTML = htmlEncode('At least one DNF is present, please correct the selected positions, or rerun the race.');
            $('#ErrorBox').modal('show');
            return false;
        }
        
        // Did we get a tie?
        // Check for "duplicate" entries
        // Note that the "1000" entries are ignored as duplicates
        // https://stackoverflow.com/questions/49215358/checking-for-duplicate-strings-in-javascript-array
        function hasDuplicates(arr) 
        {
            var counts = [];
            for (var i = 0; i <= arr.length; i++) 
            {
                if (counts[arr[i]] === undefined) 
                {
                    counts[arr[i]] = 1;
                } 
                else 
                {
                    return true;
                }
            }
            return false;
        }
        
        if ( hasDuplicates(user_selected) == true ) 
        {
            // Show Modal
            document.getElementById('ModalTitle').innerHTML = htmlEncode('Ties Not Allowed');
            document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Ties are not allowed - please correct the selected positions, or rerun the race.');
            $('#ErrorBox').modal('show');
            return false;
        }
        
        // Call the API
        const upd_response = await fetch(SaveResultsURL + '/' + aResult1 + '/' + aResult2 + '/' + aResult3 + '/' + aResult4 + '/' + aResult5 + '/' + aResult6 + '/' + Signature);
        
        if (!upd_response.ok)
        {
            throw new Error(`HTTP error! Status: ${upd_response.status}`);
        }
        var upd_data = await upd_response.json();
        
        var upd_return_code = upd_data[0].return_code;
        
        // Verify the result
        if ( upd_return_code == 0 )
        {
            // SUCCESS
            document.getElementById('ModalTitle').innerHTML = htmlEncode('Success!');
            var element = document.getElementById("modalbutton");
            element.classList = "";
            element.classList.add("btn");
            element.classList.add("btn-success");
            document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Race results have been saved! Page will refresh.');
            $('#ErrorBox').modal('show');
            return true;
        }
        else if ( upd_return_code > 0 ) 
        {
            // Error when saving results
            document.getElementById('ModalTitle').innerHTML = htmlEncode('Error');
            var element = document.getElementById("modalbutton");
            element.classList = "";
            element.classList.add("btn");
            element.classList.add("btn-danger");
            document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Error in submission. Contact Support. Return Code from database: ' + upd_return_code);
            $('#ErrorBox').modal('show');
            return false;
        }
        
    }
    
    async function CallSaveResults() 
    {
    
        try
        {
            // Get the stored data
            var dbID = sessionStorage.getItem("KubKarsScoutTrucks_dbID");
            var nmPerson =  document.getElementById('CurrentUser').innerHTML;
            var HeatID = sessionStorage.getItem("KubKarsScoutTrucks_HeatID");
            var RaceType = sessionStorage.getItem("KubKarsScoutTrucks_RaceType");
            var RaceTypeTxt = sessionStorage.getItem("KubKarsScoutTrucks_RaceTypeTxt");
            var Signature = htmlEncode(CleanseSignatureText(nmPerson));
            
            // Save positions in case the save fails
            sessionStorage.setItem("CurLane1ResultSelect",document.getElementById("CurLane1ResultSelect").value);
            sessionStorage.setItem("CurLane2ResultSelect",document.getElementById("CurLane2ResultSelect").value);
            sessionStorage.setItem("CurLane3ResultSelect",document.getElementById("CurLane3ResultSelect").value);
            sessionStorage.setItem("CurLane4ResultSelect",document.getElementById("CurLane4ResultSelect").value);
            sessionStorage.setItem("CurLane5ResultSelect",document.getElementById("CurLane5ResultSelect").value);
            sessionStorage.setItem("CurLane6ResultSelect",document.getElementById("CurLane6ResultSelect").value);
            
            // dbID must be a 1 or 2
            if (dbID == 1 || dbID == 2) 
            {
                TrackID = document.getElementById("frmTrackInput").value;
                // Change data source based on stored data
                if (dbID == 1) 
                {
                    var VehiclesPerHeatURL = window.location.origin + '/api/cubs/vehicles_per_heat';
                    var SaveResultsURL = window.location.origin + '/api/cubs/saveresults/' + RaceType + '/' + TrackID + '/' + HeatID;
                }
                if (dbID == 2) 
                {
                    var VehiclesPerHeatURL = window.location.origin + '/api/scouts/vehicles_per_heat';
                    var SaveResultsURL = window.location.origin + '/api/scouts/saveresults/' + RaceType + '/' + TrackID + '/' + HeatID;
                }
                
                // Call SaveResults
                var SaveWorked = await SaveResults(VehiclesPerHeatURL,SaveResultsURL,Signature);
                // Refresh the page data
                await refreshTrackData();
                
                // If the save worked, remove the saved positions.
                if ( SaveWorked == true )
                {
                    // Remove the saved values if the save was successful
                    sessionStorage.removeItem("CurLane1ResultSelect");
                    sessionStorage.removeItem("CurLane2ResultSelect");
                    sessionStorage.removeItem("CurLane3ResultSelect");
                    sessionStorage.removeItem("CurLane4ResultSelect");
                    sessionStorage.removeItem("CurLane5ResultSelect");
                    sessionStorage.removeItem("CurLane6ResultSelect");
                }
                else
                {
                    // Restore what was selected after the data refreshes
                    document.getElementById("CurLane1ResultSelect").value = sessionStorage.getItem("CurLane1ResultSelect");
                    document.getElementById("CurLane2ResultSelect").value = sessionStorage.getItem("CurLane2ResultSelect");
                    document.getElementById("CurLane3ResultSelect").value = sessionStorage.getItem("CurLane3ResultSelect");
                    document.getElementById("CurLane4ResultSelect").value = sessionStorage.getItem("CurLane4ResultSelect");
                    document.getElementById("CurLane5ResultSelect").value = sessionStorage.getItem("CurLane5ResultSelect");
                    document.getElementById("CurLane6ResultSelect").value = sessionStorage.getItem("CurLane6ResultSelect");
                }
                
            }
        
        } 
        catch (error) 
        {
            // draw an alert box with the error visible
            showAlert('<div class="alert alert-danger alert-dismissible" role="alert">' +
                      '  <strong>Ooops!</strong> There was an error during saving of data. You can try doing it again, or <a href="javascript:;" onclick="reload()" class="alert-link">Reload Page</a>' +
                      error +
                      '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                      '</div>');
        }
        
    }
    
    // A function that is called when a user requests a rerun for a specific race
    // Although submitting the API to unlock a heat/runoff won't break anything
    // it might be best to disable the button that was pressed to reduce the temptation.
    // Also this would serve as a visual clue that the unlock has completed.
    
    async function UnlockHeat(UnlockURL, Track, Heat, Signature, ButtonID) 
    {
        // Add an "Are You Sure"
        // Not styled at all, it is standard Javascript.
        
        if (confirm("Are you sure you want to rerun this race?"))
        {
            // Call the API to actually unlock the heat
            
            const unl_response = await fetch(UnlockURL + '/' + Track + '/' + Heat + '/' + Signature);
            if (!unl_response.ok)
            {
                throw new Error(`HTTP error! Status: ${unl_response.status}`);
            }
            var unl_data = await unl_response.json();
            
            var upd_return_code = unl_data[0].return_code;
            
            // Verify the result
            if ( upd_return_code == 0 )
            {
                // SUCCESS
                // Change the colour to success, and disable it.
                var element = document.getElementById(ButtonID);
                element.classList = "";
                element.classList.add("btn");
                element.classList.add("btn-success");
                element.classList.add("disabled");
                element.innerText = 'Unlocked!';
            }
            else if ( upd_return_code > 0 ) 
            {
                // Error when unlocking, show modal.
                document.getElementById('ModalTitle').innerHTML = htmlEncode('Error');
                var element = document.getElementById("modalbutton");
                element.classList = "";
                element.classList.add("btn");
                element.classList.add("btn-danger");
                document.getElementById('ErrorBoxText').innerHTML = htmlEncode('Error in submission. Contact Support. Return Code from database: ' + upd_return_code);
                $('#ErrorBox').modal('show');
            }
        }
    }
    
    // This function gets the set of Heats/Runoffs to be potentially "rerun"
    // It then populates the 5 available rows in the table
    
    async function fetchAndShowReruns(LatestFinishedURL,UnlockURL,RaceTypeTxt,Signature) 
    {
    
        // Call the API
        const fin_response = await fetch(LatestFinishedURL);
        
        if (!fin_response.ok)
        {
            throw new Error(`HTTP error! Status: ${fin_response.status}`);
        }
        var fin_data = await fin_response.json();
        
        // If the top 5 finished races is actually zero, then we are probably at the start
        // Or, there could be something wrong.
        // Pleading ignorance.
        if (fin_data.length == 0 ) 
        {
            // Show the modal.
            document.getElementById('ModalTitle').innerHTML = htmlEncode('Nothing to do!');
            var element = document.getElementById("modalbutton");
            element.classList = "";
            element.classList.add("btn");
            element.classList.add("btn-danger");
            document.getElementById('ErrorBoxText').innerHTML = htmlEncode('No finished ' + RaceTypeTxt + 's found, returning to regular view.');
            $('#ErrorBox').modal('show');
            HidePotentialReruns();
            return;
        }
        
        // The order of the array elements is important.
        // The most recent race is always at the top
        
        for (var i = 0; i < fin_data.length; i++) 
        {
            // RerunRow = i + 1
            var RerunRow = i + 1;
            var RerunRow_1 = 'RR' + RerunRow + '_1';
            var RerunRow_2 = 'RR' + RerunRow + '_2';
            // Make the first column just the Heat #
            document.getElementById(RerunRow_1).innerHTML = "";
            // Add the word "Latest" and an arrow to the first one, for clarity
            if (i == 0) 
            {
               document.getElementById(RerunRow_1).innerHTML = "<strong>Latest &#x1F80A; </strong>";
            }
            document.getElementById(RerunRow_1).innerHTML = document.getElementById(RerunRow_1).innerHTML + '<strong>' + RaceTypeTxt + ': # ' + fin_data[i].heat + '</strong>';
            // Make the second column a button that calls a function to unlock that heat
            document.getElementById(RerunRow_2).innerHTML = "";
            document.getElementById(RerunRow_2).innerHTML = '<button type="button" class="btn btn-primary" onclick="UnlockHeat(' + '\'' + UnlockURL + '\'' + ',' + fin_data[i].track + ',' + fin_data[i].heat + ',' + '\'' + Signature + '\'' + ',' + '\'' + RerunRow_2 + 'btn' + '\'' + ')" id="' + RerunRow_2 + 'btn' + '">Unlock</button>';
        }
        
        // If the top 5 isn't actually 5, we hide the rows that won't have anything in them
        if (fin_data.length == 4 ) 
        {
            $('#RerunRow5').hide();
        }
        if (fin_data.length == 3 ) 
        {
            $('#RerunRow4').hide();
            $('#RerunRow5').hide();
        }
        if (fin_data.length == 2 ) 
        {
            $('#RerunRow3').hide();
            $('#RerunRow4').hide();
            $('#RerunRow5').hide();
        }
        if (fin_data.length == 1 ) 
        {
            $('#RerunRow2').hide();
            $('#RerunRow3').hide();
            $('#RerunRow4').hide();
            $('#RerunRow5').hide();
        }
        
    }
    
    // This function is called when someone presses the "Oops I made a mistake" button
    // It allows someone to re-open a race
    // The function will populate a table with the last 5 races
    // Since the logic in the app forces them to run the races in numerical order, this is
    // how the reruns will be returned.
    // Note that the functions will not return a mixture of Heats/Runoffs; since they are
    // separate.
    
    function ShowPotentialReruns() 
    {
        
        // Hide the other sections to make it easier to see
        // Provide a way of "cancelling" the Ooops; show the "cancel" button
        $('#TrackSummary').hide();
        $('#CurrentRace').hide();
        $('#CurrentRaceResults').hide();
        $('#SubmitResults').hide();
        $('#RefreshButton').hide();
        $('#OopsButton').hide();
        $('#RerunTable').show();
        
        try
        {
            // Get the stored data
            var dbID = sessionStorage.getItem("KubKarsScoutTrucks_dbID");
            var nmPerson = document.getElementById('CurrentUser').innerHTML;
            var HeatID = sessionStorage.getItem("KubKarsScoutTrucks_HeatID");
            var RaceType = sessionStorage.getItem("KubKarsScoutTrucks_RaceType");
            var RaceTypeTxt = sessionStorage.getItem("KubKarsScoutTrucks_RaceTypeTxt");
            var Signature = htmlEncode(CleanseSignatureText(nmPerson));
            
            // dbID must be a 1 or 2
            if (dbID == 1 || dbID == 2) 
            {
                TrackID = document.getElementById('frmTrackInput').value;
                sessionStorage.setItem('KubKarsScoutTrucks_TrackID',document.getElementById("frmTrackInput").value);
                // Change data source based on stored data
                if (dbID == 1) 
                {
                    if (RaceType == 1) 
                    {
                        var LatestFinishedURL = window.location.origin + '/api/cubs/latest_finished_heats/' + TrackID;
                    }
                    if (RaceType == 2) 
                    {
                        var LatestFinishedURL = window.location.origin + '/api/cubs/latest_finished_runoffs/' + TrackID;
                    }
                    var UnlockURL = window.location.origin + '/api/cubs/unlockrace/' + RaceType;
                }
                if (dbID == 2) 
                {
                    if (RaceType == 1) 
                    {
                        var LatestFinishedURL = window.location.origin + '/api/scouts/latest_finished_heats/' + TrackID;
                    }
                    if (RaceType == 2) 
                    {
                        var LatestFinishedURL = window.location.origin + '/api/scouts/latest_finished_runoffs/' + TrackID;
                    }
                    var UnlockURL = window.location.origin + '/api/scouts/unlockrace/' + RaceType;
                }
                fetchAndShowReruns(LatestFinishedURL,UnlockURL,RaceTypeTxt,Signature);
            }
        }
        catch (error) 
        {
            // draw an alert box with the error visible
            showAlert('<div class="alert alert-danger alert-dismissible" role="alert">' +
                      '  <strong>Ooops!</strong> There was an error during data processing. You can try doing it again, or <a href="javascript:;" onclick="reload()" class="alert-link">Reload Page</a>' +
                      error +
                      '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                      '</div>');
        }
        
    }
    
    
    function HidePotentialReruns() 
    {
    
        // Goes back to the standard view, refreshes the data
        $('#RerunTable').hide();
        $('#TrackSummary').show();
        $('#CurrentRace').show();
        $('#CurrentRaceResults').show();
        $('#SubmitResults').show();
        $('#RefreshButton').show();
        $('#OopsButton').show();
        refreshTrackData();
    }
    
    // A function to handle Mouse/Touch events.
    // Reference used: https://medium.com/@ijlal.tanveer294/how-to-know-if-a-select-dropdown-is-open-555a304e7dda
    
    function handleInput(event) 
    {
        let x, y;
        
        if (event.touches)
        {
            // Touch events
            const touch = event.touches[0] || event.changedTouches[0];
            x = touch.clientX;
            y = touch.clientY;
        } 
        else
        {
            // Mouse events
            x = event.clientX;
            y = event.clientY;
        }

        select1rect = document.getElementById("CurLane1ResultSelect").getBoundingClientRect();
        select2rect = document.getElementById("CurLane2ResultSelect").getBoundingClientRect();
        select3rect = document.getElementById("CurLane3ResultSelect").getBoundingClientRect();
        select4rect = document.getElementById("CurLane4ResultSelect").getBoundingClientRect();
        select5rect = document.getElementById("CurLane5ResultSelect").getBoundingClientRect();
        select6rect = document.getElementById("CurLane6ResultSelect").getBoundingClientRect();
        
        IsOnASelect = (x >= select1rect.left && x <= select1rect.right && y >= select1rect.top && y <= select1rect.bottom)
                      || (x >= select2rect.left && x <= select2rect.right && y >= select2rect.top && y <= select2rect.bottom)
                      || (x >= select3rect.left && x <= select3rect.right && y >= select3rect.top && y <= select3rect.bottom)
                      || (x >= select4rect.left && x <= select4rect.right && y >= select4rect.top && y <= select4rect.bottom)
                      || (x >= select5rect.left && x <= select5rect.right && y >= select5rect.top && y <= select5rect.bottom)
                      || (x >= select6rect.left && x <= select6rect.right && y >= select6rect.top && y <= select6rect.bottom)
        ;
        
        isOpen = IsOnASelect;
        
    }
    
    // Blur triggers when an event loses focus, so naturally, a select is not open if it lost focus.
    function selectBlurHandle(event) 
    {
        isOpen = false;
    }
    
    // If the user pressed a key to simulate selection
    function selectKeyHandle(event) 
    {
        if (event.key === 'Enter' || event.keyCode === 13 || event.key === ' ' || event.keyCode === 32)
        {
            isOpen = true;
        }
    }
    
    $(document).ready(async function() 
    {
        var CurrentUserDiv = document.getElementById('CurrentUser');
        getCurrentUserId(CurrentUserDiv);
        
        // Add event listeners to the main document so that things off the control flip the switch
        document.addEventListener('mousedown', handleInput);
        document.addEventListener('click', handleInput);
        document.addEventListener('blur', selectBlurHandle);
        document.addEventListener('keydown', selectKeyHandle);
        document.addEventListener('touchmove', handleInput);
        document.addEventListener('touchstart', handleInput);
        document.addEventListener('mousemove', handleInput);
        
        // Add event listeners to the selects so that we know when the select is opened
        document.getElementById("CurLane1ResultSelect").addEventListener('mousedown', handleInput);
        document.getElementById("CurLane1ResultSelect").addEventListener('click', handleInput);
        document.getElementById("CurLane1ResultSelect").addEventListener('blur', selectBlurHandle);
        document.getElementById("CurLane1ResultSelect").addEventListener('keydown', selectKeyHandle);
        document.getElementById("CurLane1ResultSelect").addEventListener('touchmove', handleInput);
        document.getElementById("CurLane1ResultSelect").addEventListener('touchstart', handleInput);
        document.getElementById("CurLane1ResultSelect").addEventListener('mousemove', handleInput);
        
        document.getElementById("CurLane2ResultSelect").addEventListener('mousedown', handleInput);
        document.getElementById("CurLane2ResultSelect").addEventListener('click', handleInput);
        document.getElementById("CurLane2ResultSelect").addEventListener('blur', selectBlurHandle);
        document.getElementById("CurLane2ResultSelect").addEventListener('keydown', selectKeyHandle);
        document.getElementById("CurLane2ResultSelect").addEventListener('touchmove', handleInput);
        document.getElementById("CurLane2ResultSelect").addEventListener('touchstart', handleInput);
        document.getElementById("CurLane2ResultSelect").addEventListener('mousemove', handleInput);

        document.getElementById("CurLane3ResultSelect").addEventListener('mousedown', handleInput);
        document.getElementById("CurLane3ResultSelect").addEventListener('click', handleInput);
        document.getElementById("CurLane3ResultSelect").addEventListener('blur', selectBlurHandle);
        document.getElementById("CurLane3ResultSelect").addEventListener('keydown', selectKeyHandle);
        document.getElementById("CurLane3ResultSelect").addEventListener('touchmove', handleInput);
        document.getElementById("CurLane3ResultSelect").addEventListener('touchstart', handleInput);
        document.getElementById("CurLane3ResultSelect").addEventListener('mousemove', handleInput);

        document.getElementById("CurLane4ResultSelect").addEventListener('mousedown', handleInput);
        document.getElementById("CurLane4ResultSelect").addEventListener('click', handleInput);
        document.getElementById("CurLane4ResultSelect").addEventListener('blur', selectBlurHandle);
        document.getElementById("CurLane4ResultSelect").addEventListener('keydown', selectKeyHandle);
        document.getElementById("CurLane4ResultSelect").addEventListener('touchmove', handleInput);
        document.getElementById("CurLane4ResultSelect").addEventListener('touchstart', handleInput);
        document.getElementById("CurLane4ResultSelect").addEventListener('mousemove', handleInput);

        document.getElementById("CurLane5ResultSelect").addEventListener('mousedown', handleInput);
        document.getElementById("CurLane5ResultSelect").addEventListener('click', handleInput);
        document.getElementById("CurLane5ResultSelect").addEventListener('blur', selectBlurHandle);
        document.getElementById("CurLane5ResultSelect").addEventListener('keydown', selectKeyHandle);
        document.getElementById("CurLane5ResultSelect").addEventListener('touchmove', handleInput);
        document.getElementById("CurLane5ResultSelect").addEventListener('touchstart', handleInput);
        document.getElementById("CurLane5ResultSelect").addEventListener('mousemove', handleInput);

        document.getElementById("CurLane6ResultSelect").addEventListener('mousedown', handleInput);
        document.getElementById("CurLane6ResultSelect").addEventListener('click', handleInput);
        document.getElementById("CurLane6ResultSelect").addEventListener('blur', selectBlurHandle);
        document.getElementById("CurLane6ResultSelect").addEventListener('keydown', selectKeyHandle);
        document.getElementById("CurLane6ResultSelect").addEventListener('touchmove', handleInput);
        document.getElementById("CurLane6ResultSelect").addEventListener('touchstart', handleInput);
        document.getElementById("CurLane6ResultSelect").addEventListener('mousemove', handleInput);
        
        // Add a listener for auto-selecting the result
        document.getElementById("CurLane1ResultSelect").addEventListener('change', finishSelection);
        document.getElementById("CurLane2ResultSelect").addEventListener('change', finishSelection);
        document.getElementById("CurLane3ResultSelect").addEventListener('change', finishSelection);
        document.getElementById("CurLane4ResultSelect").addEventListener('change', finishSelection);
        document.getElementById("CurLane5ResultSelect").addEventListener('change', finishSelection);
        document.getElementById("CurLane6ResultSelect").addEventListener('change', finishSelection);
        
        // Add an event listener to look for changes to the selection of track
        document.getElementById("frmTrackInput").addEventListener("change", refreshTrackData);
        
        // Add a simple timer for refreshing
        setInterval(autoRefresh, 30000);
        
        // Hide the reruns until someone presses the button to show them
        $('#RerunTable').hide();
        
        // Get the stored data
        var dbID = sessionStorage.getItem("KubKarsScoutTrucks_dbID");
        var nmPerson = document.getElementById('CurrentUser').innerHTML;
        
        // Get the TrackID, must be an integer
        var TrackID = sessionStorage.getItem('KubKarsScoutTrucks_TrackID');
        num_trackID = parseInt(TrackID);
        document.getElementById('CurrentTrack').innerHTML = htmlEncode(num_trackID);
        
        // dbID must be a 1 or 2
        if (dbID == 1 || dbID == 2) 
        {
        
            // Change data source based on dbID
            if (dbID == 1) 
            {
                document.getElementById('MainHeader').innerHTML = htmlEncode('Kub Kars - Recording');
                var TracksUrl = window.location.origin + '/api/cubs/tracks';
                var VehiclesPerHeatURL = window.location.origin + '/api/cubs/vehicles_per_heat';
            }
            
            if (dbID == 2) 
            {
                document.getElementById('MainHeader').innerHTML = htmlEncode('Scout Trucks - Recording');
                var TracksUrl = window.location.origin + '/api/scouts/tracks';
                var VehiclesPerHeatURL = window.location.origin + '/api/scouts/vehicles_per_heat';
            }
            
            try 
            {
                // Put those Track Ids in the select dropdown.
                // Call the function to populate the Track List
                await fetchDataAndPopulateDropdown(TracksUrl);
                
                if (Number.isInteger(num_trackID)) 
                {
                    // Make sure the option exists
                    if ( optionExists( TrackID, document.getElementById('frmTrackInput') ) )
                    {
                        // Select the Option based on the stored data
                        document.getElementById('frmTrackInput').value = num_trackID;
                        // Raise an event to force a refresh
                        document.getElementById('frmTrackInput').dispatchEvent(new Event('change'));
                        // If the TrackID is set, hide the selector
                        HideTrackSelector();
                    }
                    else
                    {
                          sessionStorage.removeItem('KubKarsScoutTrucks_TrackID');
                          ShowTrackSelector();
                          $('#TrackContent').hide();
                    }
                }
                else
                {
                    // If the trackid is not set, show the selector.
                    ShowTrackSelector();
                    $('#TrackContent').hide();
                }
            } 
            catch (error) 
            {
                // draw an alert box with the error visible
                showAlert('<div class="alert alert-danger alert-dismissible" role="alert">' +
                          '  <strong>Ooops!</strong> There was an error during retrieval of data. <a href="javascript:;" onclick="reload()" class="alert-link">Reload Page</a>' +
                          error +
                          '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                          '</div>');
            }
        } 
        else 
        {
            // Show the alert
            showAlert('<div class="alert alert-danger alert-dismissible" role="alert">' +
                      '  <strong>Ooops!</strong> No Section data available. <a href="/kubkars" class="alert-link">Start Over</a>' +
                      '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                      '</div>');
        }

    });
 
  </script>
  
</head>

<body>

  <!-- Temporary Modal box, shows up after pressing Save Results -->
  <div class="modal" id="ErrorBox">
    <div class="modal-dialog">
      <div class="modal-content">
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title" id="ModalTitle"></h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <!-- Modal body -->
        <div class="modal-body" id="ErrorBoxText">
        </div>
        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="modalbutton">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Offcanvas Sidebar -->
  <div class="offcanvas offcanvas-start" id="RoleSwitcher">
    <div class="offcanvas-header">
      <h1 class="offcanvas-title">Switch Role</h1>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <p>Choose a role to switch to, or start again:</p>
      <p>
      <a href="/kubkars" class="btn btn-primary">Start Over</a>
      <p>
      <a href="/setting_up" class="btn btn-primary">Setting Up</a> 
      <p>
      <a href="/recording" class="btn btn-primary">Recording</a> 
      <p>
      <a href="/monitoring" class="btn btn-primary">Monitoring</a> 
      <p>
    </div>
    <div class="offcanvas-bottom text-center">
      <form action="/logout" method="post"><a class='btn btn-danger' href="javascript:;" onclick="parentNode.submit();">Log out</a></form> 
      <p>
    </div>
  </div>

  <div class="container-fluid p-4 bg-warning text-black text-center">
    <h1 id="MainHeader"></h1>
    <!-- Button to open the offcanvas sidebar -->
    <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#RoleSwitcher">Switch Role</button> 
    <!-- Button to switch tracks -->
    <button class="btn btn-primary" type="button" id="SwitchTracksButton" onclick="ShowHideTrackSelector()">Switch Tracks</button>
    <br>Current Track: <b><span id="CurrentTrack"></span></b>
    <br>Logged in as: <b><span id="CurrentUser"></span></b>
  </div>
  
  <!-- Container for any alerts -->
  <div id="liveAlertPlaceholder"></div>
  
  <!-- Main Page Container -->
  <div class="container-fluid p-4 bg-white text-black text-center" id="mainPageContent">
  
    <!-- Selector for Track -->
    <div id="TrackSelector">
      <br>
      <label for="frmTrackInput"><h4>Select Track:</h4></label>
      <select class="form-select" id="frmTrackInput" required>
        <option value="default" selected>Choose Track...</option>
      </select>
      <br>
    </div>
    <!-- Track Data -->
    <br>
    <div class="container" id="TrackContent">
      
      <!-- Current Heat -->
      <!-- Not all lanes will be shown, depends on Vehicles Per Heat setting. -->
      <div id="CurrentRace">
        <h4>Current Race & Lane Info:</h4>
        <div class="container-fluid">
          <div class="row justify-content-center">
            <div class="col border bg-light text-end"><strong>Race #:</strong></div><div class="col border" id='CurRaceNum'></div>
          </div>
          <div class="row justify-content-center">
            <div class="col border bg-light text-end"><strong>Race Type:</strong></div><div class="col border" id='CurRaceType'></div>
          </div>
          <div class="row justify-content-center" id="CurLane1Row">
            <div class="col border bg-light text-end"><strong>Lane 1:</strong></div><div class="col border" id='CurLane1CarID'></div>
          </div>
          <div class="row justify-content-center" id="CurLane2Row">
            <div class="col border bg-light text-end"><strong>Lane 2:</strong></div><div class="col border" id='CurLane2CarID'></div>
          </div>
          <div class="row justify-content-center" id="CurLane3Row">
            <div class="col border bg-light text-end"><strong>Lane 3:</strong></div><div class="col border" id='CurLane3CarID'></div>
          </div>
          <div class="row justify-content-center" id="CurLane4Row">
            <div class="col border bg-light text-end"><strong>Lane 4:</strong></div><div class="col border" id='CurLane4CarID'></div>
          </div>
          <div class="row justify-content-center" id="CurLane5Row">
            <div class="col border bg-light text-end"><strong>Lane 5:</strong></div><div class="col border" id='CurLane5CarID'></div>
          </div>
          <div class="row justify-content-center" id="CurLane6Row">
            <div class="col border bg-light text-end"><strong>Lane 6:</strong></div><div class="col border" id='CurLane6CarID'></div>
          </div>
        </div>
        <br>
      </div>
      
      <!-- A Refresh Data Button -->
      <button type="button" class="btn btn-primary" onclick="refreshTrackData()" id="RefreshButton">Refresh</button>
      <br>
      <br>
      
      <div id="CurrentRaceResults">
        <h4>Race Results:</h4>
        <div class="container-fluid">
          <div class="row justify-content-center" id="CurLane1ResultRow">
            <div class="col border bg-light text-end"><strong>Lane 1 (Car #<span id="CurLane1CarIDNum"></span>):</strong></div><div class="col border" id='CurLane1Result'><select class="form-select form-select-sm" id="CurLane1ResultSelect"></select></div>
          </div>
          <div class="row justify-content-center" id="CurLane2ResultRow">
            <div class="col border bg-light text-end"><strong>Lane 2 (Car #<span id="CurLane2CarIDNum"></span>):</strong></div><div class="col border" id='CurLane2Result'><select class="form-select form-select-sm" id="CurLane2ResultSelect"></select></div>
          </div>
          <div class="row justify-content-center" id="CurLane3ResultRow">
            <div class="col border bg-light text-end"><strong>Lane 3 (Car #<span id="CurLane3CarIDNum"></span>):</strong></div><div class="col border" id='CurLane3Result'><select class="form-select form-select-sm" id="CurLane3ResultSelect"></select></div>
          </div>
          <div class="row justify-content-center" id="CurLane4ResultRow">
            <div class="col border bg-light text-end"><strong>Lane 4 (Car #<span id="CurLane4CarIDNum"></span>):</strong></div><div class="col border" id='CurLane4Result'><select class="form-select form-select-sm" id="CurLane4ResultSelect"></select></div>
          </div>
          <div class="row justify-content-center" id="CurLane5ResultRow">
            <div class="col border bg-light text-end"><strong>Lane 5 (Car #<span id="CurLane5CarIDNum"></span>):</strong></div><div class="col border" id='CurLane5Result'><select class="form-select form-select-sm" id="CurLane5ResultSelect"></select></div>
          </div>
          <div class="row justify-content-center" id="CurLane6ResultRow">
            <div class="col border bg-light text-end"><strong>Lane 6 (Car #<span id="CurLane6CarIDNum"></span>):</strong></div><div class="col border" id='CurLane6Result'><select class="form-select form-select-sm" id="CurLane6ResultSelect"></select></div>
          </div>
        </div>
      </div>

      <!-- Recording the results is done by the user clicking a button -->
      <!-- Verify they selected the right positions, no ties -->
      <!-- Confirm submission -->
      <br>
      <div id="SubmitResults">
        <!-- A Save Results Button -->
        <button type="button" class="btn btn-primary" onclick="CallSaveResults()">Save Results</button>
      </div>

      <div id="Rerun">
        <br>
        <hr>
        <br>
        <!-- Here we provide a way for someone to undo a result  -->
        <button type="button" class="btn btn-primary" onclick="ShowPotentialReruns()" id="OopsButton">Ooops! I need to rerun a race!</button>
        <!-- Table of the last 5 races; Mixing of RunOffs and Heats is not possible -->
        <!-- Hidden until someone presses the button -->
        <div id="RerunTable">
          <div class="container-fluid">
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><center><strong>Unlock List</strong></center></div>
            </div>
            <div class="row justify-content-center" id="RerunRow1">
              <div class="col border bg-light text-end" id="RR1_1"></div><div class="col border" id='RR1_2'></div>
            </div>
            <div class="row justify-content-center" id="RerunRow2">
              <div class="col border bg-light text-end" id="RR2_1"></div><div class="col border" id='RR2_2'></div>
            </div>
            <div class="row justify-content-center" id="RerunRow3">
              <div class="col border bg-light text-end" id="RR3_1"></div><div class="col border" id='RR3_2'></div>
            </div>
            <div class="row justify-content-center" id="RerunRow4">
              <div class="col border bg-light text-end" id="RR4_1"></div><div class="col border" id='RR4_2'></div>
            </div>
            <div class="row justify-content-center" id="RerunRow5">
              <div class="col border bg-light text-end" id="RR5_1"></div><div class="col border" id='RR5_2'></div>
            </div>
          </div>
          <br>
          <button type="button" class="btn btn-primary" onclick="HidePotentialReruns()">Click here when done unlocking</button>
        </div>
      </div>
      
      <!-- A summary at the bottom of the page -->
      <div id="TrackSummary">
        <br>
        <hr>
        <br>
        <div id="HeatSummary">
          <h4>Heat Summary</h4>
          <div class="container-fluid">
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Total:</strong></div><div class="col border" id='statTotalHeats'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Finished:</strong></div><div class="col border" id='statFinishedHeats'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Unfinished:</strong></div><div class="col border" id='statUnfinishedHeats'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>% Complete:</strong></div><div class="col border" id='statHeatPercentComplete'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Current Heat:</strong></div><div class="col border" id='statCurrentHeat'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Next Heat:</strong></div><div class="col border" id='statNextHeat'></div>
            </div>
          </div>
        </div>
        <div id="RunOffSummary">
          <h4>Run-Off Summary</h4>
          <div class="container-fluid">
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Total RunOffs:</strong></div><div class="col border" id='statTotalRunOffs'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Finished:</strong></div><div class="col border" id='statFinishedRunOffs'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Unfinished:</strong></div><div class="col border" id='statUnfinishedRunOffs'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>% Complete:</strong></div><div class="col border" id='statROPercentComplete'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Current RunOff:</strong></div><div class="col border" id='statCurrentRunOff'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Next RunOff:</strong></div><div class="col border" id='statNextRunOff'></div>
            </div>
          </div>
          <br>
        </div>
      </div>      
      <!-- A Hidden div, shown when all races are finished -->
      <div id="AllRacesComplete">
        <h3>Racing Finished!</h3>
      </div>
      
    </div>

  </div>
  
</body>
</html>