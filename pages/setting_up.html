<!DOCTYPE html>
<html lang="en-CA">
<head>
  <meta charset="utf-8">
  <title>Kub Kars and Scout Trucks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/libs/bootstrap-5.3.3-dist/css/bootstrap.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="/assets/images/Scouts-Badge.png">
  <script src="/libs/jquery-3.7.1.min.js" type="application/javascript"></script>
  <script src="/libs/bootstrap-5.3.3-dist/js/bootstrap.js" type="application/javascript"></script>
  <script src="/libs/popper.min.js" type="application/javascript"></script>
  <script src="/libs/common.js" type="application/javascript"></script>
  
  <script>
    
    // I'm aware that I mix JQuery calls with JavaScript here, notably things like:
    // 
    // $('#xxx).hide();
    // and 
    // document.getElementById(xxx)
    //
    // And that ideally, we would not want to mix them. 
    // 
    // Well, I tried using the style.display instead of show(), hide(). All my layouts pooched. Screw that. I gave up. 
    // Why bother? One line. Thats it.
    // I'll live with it. 
    // 
    // :-)
    //
    
    // A function to show an alert when there is an error
    function showAlert(CustomInnerHTML) 
    {
        const alertPlaceholder = document.getElementById('liveAlertPlaceholder')
        const appendAlert = () => 
        {
            const wrapper = document.createElement('div');
            wrapper.innerHTML = [CustomInnerHTML].join('');
            alertPlaceholder.append(wrapper);
        }
        appendAlert();
    }
    
    function ShowTrackSelector()
    {
        // Returns TRUE when the div is showing
        $('#TrackSelector').show();
        // Change the text of the track switch button
        document.getElementById('SwitchTracksButton').textContent = 'Hide Track Switcher';
    }
    
    function HideTrackSelector()
    {
        // Returns TRUE when the div is showing
        $('#TrackSelector').hide();
        // Change the text of the track switch button
        document.getElementById('SwitchTracksButton').textContent = 'Switch Tracks';
    }
    
    function ShowHideTrackSelector()
    {
        // If hidden, show it, and vice-versa.
        
        if (document.getElementById('TrackSelector').checkVisibility() )
        {
            HideTrackSelector();
        }
        else
        {
            ShowTrackSelector();
        }
    }
    
    // A function to call the API to put the Track IDs in the dropdown
    async function fetchDataAndPopulateDropdown(apiurl)
    {
        try
        {
            const response = await fetch(apiurl);
            if (!response.ok)
            {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const data = await response.json();
            const dropdown = document.getElementById('frmTrackInput');
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.track;
                option.textContent = item.track;
                dropdown.appendChild(option);
            });
        } 
        catch (error)
        {
            showAlert('<div class="alert alert-danger alert-dismissible" role="alert">' +
                      '  <strong>Ooops!</strong> There was an error during retrieval of data. <a href="javascript:;" onclick="reload()" class="alert-link">Reload Page</a> OR <a href="/kubkars" class="alert-link">Start Again</a>. Error Text: ' +
                      error +
                     '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                     '</div>')
        }
    }
    
    // A function to update the summary data for the selected track
    // data[0] is used because the summary ALWAYS returns ONE record.
    
    async function fetchAndPopulateRaceAndSummary(TrackSummaryURL,RaceURL,VehiclesPerHeatURL)
    {
        try
        {
            const vph_response = await fetch(VehiclesPerHeatURL);
            if (!vph_response.ok) 
            {
                throw new Error(`HTTP error! Status: ${vph_response.status}`);
            }
            const vph_data = await vph_response.json();

            var vehicles_per_heat = vph_data[0].VehiclesPerHeat;

            const t_response = await fetch(TrackSummaryURL);
            if (!t_response.ok) 
            {
                throw new Error(`HTTP error! Status: ${t_response.status}`);
            }
            const t_data = await t_response.json();
            
            // Heat Summary
            document.getElementById('statHeatPercentComplete').innerHTML = htmlEncode(t_data[0].heats_pct_complete);
            document.getElementById('statTotalHeats').innerHTML = htmlEncode(t_data[0].total_heat_count);
            document.getElementById('statFinishedHeats').innerHTML = htmlEncode(t_data[0].finished_heats);
            document.getElementById('statUnfinishedHeats').innerHTML = htmlEncode(t_data[0].unfinished_heats);
            document.getElementById('statCurrentHeat').innerHTML = htmlEncode(t_data[0].current_heat);
            document.getElementById('statNextHeat').innerHTML = htmlEncode(t_data[0].next_heat);
            // Runoff Summary
            document.getElementById('statTotalRunOffs').innerHTML = htmlEncode(t_data[0].total_runoff_count);
            document.getElementById('statFinishedRunOffs').innerHTML = htmlEncode(t_data[0].finished_runoffs);
            document.getElementById('statUnfinishedRunOffs').innerHTML = htmlEncode(t_data[0].unfinished_runoffs);
            document.getElementById('statROPercentComplete').innerHTML = htmlEncode(t_data[0].runoffs_pct_complete);
            document.getElementById('statCurrentRunOff').innerHTML = htmlEncode(t_data[0].current_runoff);
            document.getElementById('statNextRunOff').innerHTML = htmlEncode(t_data[0].next_runoff);
            
            // Clear the Current Race Entries
            document.getElementById('CurRaceNum').innerHTML = '';
            document.getElementById('CurLane1CarID').innerHTML = '';
            document.getElementById('CurLane2CarID').innerHTML = '';
            document.getElementById('CurLane3CarID').innerHTML = '';
            document.getElementById('CurLane4CarID').innerHTML = '';
            document.getElementById('CurLane5CarID').innerHTML = '';
            document.getElementById('CurLane6CarID').innerHTML = '';
            // Clear the Next Race Entries
            document.getElementById('NxtRaceNum').innerHTML = '';
            document.getElementById('NxtLane1CarID').innerHTML = '';
            document.getElementById('NxtLane2CarID').innerHTML = '';
            document.getElementById('NxtLane3CarID').innerHTML = '';
            document.getElementById('NxtLane4CarID').innerHTML = '';
            document.getElementById('NxtLane5CarID').innerHTML = '';
            document.getElementById('NxtLane6CarID').innerHTML = '';
            
            // TODO: Images or Colours for visibility?
            
            
            // Show the heats if they are not finished
            if ( parseFloat(t_data[0].heats_pct_complete) < 100 && parseFloat(t_data[0].heats_pct_complete) >= 0 )
            {
                // Current Heat Data
                const ch_response = await fetch(RaceURL + '/' + t_data[0].current_heat + '/1');
                if (!ch_response.ok) 
                {
                    throw new Error(`HTTP error! Status: ${ch_response.status}`);
                }
                const ch_data = await ch_response.json();
                
                // Hide the "Races Complete" div
                $('#AllRacesComplete').hide();
                // Show the Heats, hide the run-offs (not started)
                $('#HeatSummary').show();
                $('#RunOffSummary').hide();
                
                // Current Race Updates:
                document.getElementById('CurRaceNum').innerHTML = htmlEncode(t_data[0].current_heat);
                document.getElementById('CurRaceType').innerHTML = htmlEncode('Heat');
                
                // There's probably a nicer way of doing this, but this works.
                
                // Hide them all
                $('#CurLane1Row').hide();
                $('#CurLane2Row').hide();
                $('#CurLane3Row').hide();
                $('#CurLane4Row').hide();
                $('#CurLane5Row').hide();
                $('#CurLane6Row').hide();
                
                // Show them based on the vehicles_per_heat setting

                if ( vehicles_per_heat == 6 )
                {
                    if (ch_data[0].lane6_carNumber == -1 )
                    {
                        document.getElementById('CurLane6CarID').innerHTML = 'No Racer';
                    }
                    else
                    {
                        document.getElementById('CurLane6CarID').innerHTML = htmlEncode(ch_data[0].lane6_carNumber + ' - ' + ch_data[0].lane6_driver + ' (' + ch_data[0].lane6_group + ')');
                    }
                    
                    $('#CurLane6Row').show();
                }
                
                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 ) 
                {
                    
                    if (ch_data[0].lane5_carNumber == -1 )
                    {
                        document.getElementById('CurLane5CarID').innerHTML = 'No Racer';
                    }
                    else
                    {
                        document.getElementById('CurLane5CarID').innerHTML = htmlEncode(ch_data[0].lane5_carNumber + ' - ' + ch_data[0].lane5_driver + ' (' + ch_data[0].lane5_group + ')');
                    }
                    
                    $('#CurLane5Row').show();
                }
                
                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 ){
                    
                    if (ch_data[0].lane4_carNumber == -1 )
                    {
                        document.getElementById('CurLane4CarID').innerHTML = 'No Racer';
                    }
                    else
                    {
                        document.getElementById('CurLane4CarID').innerHTML = htmlEncode(ch_data[0].lane4_carNumber + ' - ' + ch_data[0].lane4_driver + ' (' + ch_data[0].lane4_group + ')');
                    }
                    
                    $('#CurLane4Row').show();
                }

                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 ) 
                {
                    
                    if (ch_data[0].lane3_carNumber == -1 )
                    {
                        document.getElementById('CurLane3CarID').innerHTML = 'No Racer';
                    }
                    else
                    {
                        document.getElementById('CurLane3CarID').innerHTML = htmlEncode(ch_data[0].lane3_carNumber + ' - ' + ch_data[0].lane3_driver + ' (' + ch_data[0].lane3_group + ')');
                    }
                    
                    $('#CurLane3Row').show();
                }

                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 || vehicles_per_heat == 2 )
                {
                    if (ch_data[0].lane2_carNumber == -1 )
                    {
                        document.getElementById('CurLane2CarID').innerHTML = 'No Racer';
                    }
                    else
                    {
                        document.getElementById('CurLane2CarID').innerHTML = htmlEncode(ch_data[0].lane2_carNumber + ' - ' + ch_data[0].lane2_driver + ' (' + ch_data[0].lane2_group + ')');
                    }
                    
                    $('#CurLane2Row').show();
                    
                    if (ch_data[0].lane1_carNumber == -1 )
                    {
                        document.getElementById('CurLane1CarID').innerHTML = 'No Racer';
                    }
                    else
                    {
                        document.getElementById('CurLane1CarID').innerHTML = htmlEncode(ch_data[0].lane1_carNumber + ' - ' + ch_data[0].lane1_driver + ' (' + ch_data[0].lane1_group + ')');
                    }
                    
                    $('#CurLane1Row').show();
                }
                
                // Show Current Race
                $('#CurrentRace').show();
                
                // Hide all Next Race rows.
                $('#NxtLane1Row').hide();
                $('#NxtLane2Row').hide();
                $('#NxtLane3Row').hide();
                $('#NxtLane4Row').hide();
                $('#NxtLane5Row').hide();
                $('#NxtLane6Row').hide();
                
                // Next Race Updates:
                if ( t_data[0].next_heat == 0 )
                {
                    document.getElementById('NxtRaceNum').innerHTML = "None Left";
                }
                else
                {
                    // Next Heat Data
                    const nh_response = await fetch(RaceURL + '/' + t_data[0].next_heat + '/1');
                    if (!nh_response.ok) 
                    {
                        throw new Error(`HTTP error! Status: ${nh_response.status}`);
                    }
                    const nh_data = await nh_response.json();
                
                    document.getElementById('NxtRaceNum').innerHTML = htmlEncode(t_data[0].next_heat);
                    document.getElementById('NxtRaceType').innerHTML = htmlEncode('Heat');

                    // Show them based on the vehicles_per_heat setting
                    
                    if ( vehicles_per_heat == 6 ) 
                    {
                        if (nh_data[0].lane6_carNumber == -1 )
                        {
                            document.getElementById('NxtLane6CarID').innerHTML = 'No Racer';
                        }
                        else
                        {
                            document.getElementById('NxtLane6CarID').innerHTML = htmlEncode(nh_data[0].lane6_carNumber + ' - ' + nh_data[0].lane6_driver + ' (' + nh_data[0].lane6_group + ')');
                        }
                        
                        $('#NxtLane6Row').show();
                    }
                    
                    if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 ) 
                    {
                        if (nh_data[0].lane5_carNumber == -1 )
                        {
                            document.getElementById('NxtLane5CarID').innerHTML = 'No Racer';
                        }
                        else
                        {
                            document.getElementById('NxtLane5CarID').innerHTML = htmlEncode(nh_data[0].lane5_carNumber + ' - ' + nh_data[0].lane5_driver + ' (' + nh_data[0].lane5_group + ')');
                        }
                        $('#NxtLane5Row').show();
                    }
                        
                    if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 ) 
                    {
                        if (nh_data[0].lane4_carNumber == -1 )
                        {
                            document.getElementById('NxtLane4CarID').innerHTML = 'No Racer';
                        }
                        else
                        {
                            document.getElementById('NxtLane4CarID').innerHTML = htmlEncode(nh_data[0].lane4_carNumber + ' - ' + nh_data[0].lane4_driver + ' (' + nh_data[0].lane4_group + ')');
                        }
                        
                        $('#NxtLane4Row').show();
                    }
                        
                    if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 ) 
                    {
                        if (nh_data[0].lane3_carNumber == -1 )
                        {
                            document.getElementById('NxtLane3CarID').innerHTML = 'No Racer';
                        }
                        else
                        {
                            document.getElementById('NxtLane3CarID').innerHTML = htmlEncode(nh_data[0].lane3_carNumber + ' - ' + nh_data[0].lane3_driver + ' (' + nh_data[0].lane3_group + ')');
                        }
                        
                        $('#NxtLane3Row').show();
                    }
                        
                    if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 || vehicles_per_heat == 2 ) 
                    {
                        if (nh_data[0].lane2_carNumber == -1 )
                        {
                            document.getElementById('NxtLane2CarID').innerHTML = 'No Racer';
                        }
                        else
                        {
                            document.getElementById('NxtLane2CarID').innerHTML = htmlEncode(nh_data[0].lane2_carNumber + ' - ' + nh_data[0].lane2_driver + ' (' + nh_data[0].lane2_group + ')');
                        }
                        
                        $('#NxtLane2Row').show();
                        
                        if (nh_data[0].lane1_carNumber == -1 )
                        {
                            document.getElementById('NxtLane1CarID').innerHTML = 'No Racer';
                        }
                        else
                        {
                            document.getElementById('NxtLane1CarID').innerHTML = htmlEncode(nh_data[0].lane1_carNumber + ' - ' + nh_data[0].lane1_driver + ' (' + nh_data[0].lane1_group + ')');
                        }
                        
                        $('#NxtLane1Row').show();
                    }

                    $('#NextRace').show();

                }
                
            }
            // Hide the heats and show the runoffs if these are incomplete
            else if ( parseFloat(t_data[0].heats_pct_complete) == 100 && parseFloat(t_data[0].runoffs_pct_complete) < 100 && parseFloat(t_data[0].runoffs_pct_complete) >= 0 )
            {
                // Hide the "Races Complete" div
                $('#AllRacesComplete').hide();
                // Hide the heats
                $('#HeatSummary').hide();
                // Show the Run Offs
                $('#RunOffSummary').show();
                
                // Current RunOff Data
                const cr_response = await fetch(RaceURL + '/' + t_data[0].current_runoff + '/2');
                if (!cr_response.ok) 
                {
                    throw new Error(`HTTP error! Status: ${cr_response.status}`);
                }
                const cr_data = await cr_response.json();
                
                // Current Race Updates:
                document.getElementById('CurRaceNum').innerHTML = htmlEncode(t_data[0].current_runoff);
                document.getElementById('CurRaceType').innerHTML = htmlEncode('RunOff');
                
                // There's probably a nicer way of doing this, but this works.
                
                // Hide them all
                $('#CurLane1Row').hide();
                $('#CurLane2Row').hide();
                $('#CurLane3Row').hide();
                $('#CurLane4Row').hide();
                $('#CurLane5Row').hide();
                $('#CurLane6Row').hide();
                
                // Show them based on the vehicles_per_heat setting

                if ( vehicles_per_heat == 6 ) 
                {
                    if (cr_data[0].lane6_carNumber == -1 )
                    {
                        document.getElementById('CurLane6CarID').innerHTML = 'No Racer';
                    }
                    else
                    {
                        document.getElementById('CurLane6CarID').innerHTML = htmlEncode(cr_data[0].lane6_carNumber + ' - ' + cr_data[0].lane6_driver + ' (' + cr_data[0].lane6_group + ')');
                    }
                    
                    $('#CurLane6Row').show();
                }
                
                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 ) 
                {
                    if (cr_data[0].lane5_carNumber == -1 )
                    {
                        document.getElementById('CurLane5CarID').innerHTML = 'No Racer';
                    }
                    else
                    {
                        document.getElementById('CurLane5CarID').innerHTML = htmlEncode(cr_data[0].lane5_carNumber + ' - ' + cr_data[0].lane5_driver + ' (' + cr_data[0].lane5_group + ')');
                    }
                    
                    $('#CurLane5Row').show();
                }
                
                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 ) 
                {
                    if (cr_data[0].lane4_carNumber == -1 )
                    {
                        document.getElementById('CurLane4CarID').innerHTML = 'No Racer';
                    }
                    else
                    {
                        document.getElementById('CurLane4CarID').innerHTML = htmlEncode(cr_data[0].lane4_carNumber + ' - ' + cr_data[0].lane4_driver + ' (' + cr_data[0].lane4_group + ')');
                    }
                    
                    $('#CurLane4Row').show();
                }

                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 ) 
                {
                    if (cr_data[0].lane3_carNumber == -1 )
                    {
                        document.getElementById('CurLane3CarID').innerHTML = 'No Racer';
                    }
                    else
                    {
                        document.getElementById('CurLane3CarID').innerHTML = htmlEncode(cr_data[0].lane3_carNumber + ' - ' + cr_data[0].lane3_driver + ' (' + cr_data[0].lane3_group + ')');
                    }
                    
                    $('#CurLane3Row').show();
                }

                if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 || vehicles_per_heat == 2 )
                {
                    if (cr_data[0].lane2_carNumber == -1 )
                    {
                        document.getElementById('CurLane2CarID').innerHTML = 'No Racer';
                    }
                    else
                    {
                        document.getElementById('CurLane2CarID').innerHTML = htmlEncode(cr_data[0].lane2_carNumber + ' - ' + cr_data[0].lane2_driver + ' (' + cr_data[0].lane2_group + ')');
                    }
                    
                    $('#CurLane2Row').show();
                    
                    if (cr_data[0].lane1_carNumber == -1 )
                    {
                        document.getElementById('CurLane1CarID').innerHTML = 'No Racer';
                    }
                    else
                    {
                        document.getElementById('CurLane1CarID').innerHTML = htmlEncode(cr_data[0].lane1_carNumber + ' - ' + cr_data[0].lane1_driver + ' (' + cr_data[0].lane1_group + ')');
                    }
                    
                    $('#CurLane1Row').show();
                }

                // Show Current Race
                $('#CurrentRace').show();

                // Next Race Updates:
                
                // Hide them all
                $('#NxtLane1Row').hide();
                $('#NxtLane2Row').hide();
                $('#NxtLane3Row').hide();
                $('#NxtLane4Row').hide();
                $('#NxtLane5Row').hide();
                $('#NxtLane6Row').hide();
                
                // Next Race Updates:
                
                if ( t_data[0].next_runoff == 0 )
                {
                    document.getElementById('NxtRaceNum').innerHTML = "None Left";
                }
                else
                {
                    const nr_response = await fetch(RaceURL + '/' + t_data[0].next_runoff + '/2');
                    if (!nr_response.ok) 
                    {
                        throw new Error(`HTTP error! Status: ${nr_response.status}`);
                    }
                    const nr_data = await nr_response.json();

                    document.getElementById('NxtRaceNum').innerHTML = htmlEncode(t_data[0].next_runoff);
                    document.getElementById('NxtRaceType').innerHTML = htmlEncode('RunOff');

                    // Show them based on the vehicles_per_heat setting
                    
                    if ( vehicles_per_heat == 6 ) 
                    {
                        if (nr_data[0].lane6_carNumber == -1 )
                        {
                            document.getElementById('NxtLane6CarID').innerHTML = 'No Racer';
                        }
                        else
                        {
                            document.getElementById('NxtLane6CarID').innerHTML = htmlEncode(nr_data[0].lane6_carNumber + ' - ' + nr_data[0].lane6_driver + ' (' + nr_data[0].lane6_group + ')');
                        }
                        $('#NxtLane6Row').show();
                    }
                    
                    if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 ) 
                    {
                        if (nr_data[0].lane5_carNumber == -1 )
                        {
                            document.getElementById('NxtLane5CarID').innerHTML = 'No Racer';
                        }
                        else
                        {
                            document.getElementById('NxtLane5CarID').innerHTML = htmlEncode(nr_data[0].lane5_carNumber + ' - ' + nr_data[0].lane5_driver + ' (' + nr_data[0].lane5_group + ')');
                        }
                        $('#NxtLane5Row').show();
                    }
                        
                    if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 ) 
                    {
                        if (nr_data[0].lane4_carNumber == -1 )
                        {
                            document.getElementById('NxtLane4CarID').innerHTML = 'No Racer';
                        }
                        else
                        {
                            document.getElementById('NxtLane4CarID').innerHTML = htmlEncode(nr_data[0].lane4_carNumber + ' - ' + nr_data[0].lane4_driver + ' (' + nr_data[0].lane4_group + ')');
                        }
                        $('#NxtLane4Row').show();
                    }
                        
                    if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 ) 
                    {
                        if (nr_data[0].lane3_carNumber == -1 )
                        {
                            document.getElementById('NxtLane3CarID').innerHTML = 'No Racer';
                        }
                        else
                        {
                            document.getElementById('NxtLane3CarID').innerHTML = htmlEncode(nr_data[0].lane3_carNumber + ' - ' + nr_data[0].lane3_driver + ' (' + nr_data[0].lane3_group + ')');
                        }
                        $('#NxtLane3Row').show();
                    }
                        
                    if ( vehicles_per_heat == 6 || vehicles_per_heat == 5 || vehicles_per_heat == 4 || vehicles_per_heat == 3 || vehicles_per_heat == 2 ) 
                    {
                        if (nr_data[0].lane2_carNumber == -1 )
                        {
                            document.getElementById('NxtLane2CarID').innerHTML = 'No Racer';
                        }
                        else
                        {
                            document.getElementById('NxtLane2CarID').innerHTML = htmlEncode(nr_data[0].lane2_carNumber + ' - ' + nr_data[0].lane2_driver + ' (' + nr_data[0].lane2_group + ')');
                        }
                        $('#NxtLane2Row').show();
                        
                        if (nr_data[0].lane1_carNumber == -1 )
                        {
                            document.getElementById('NxtLane1CarID').innerHTML = 'No Racer';
                        }
                        else
                        {
                            document.getElementById('NxtLane1CarID').innerHTML = htmlEncode(nr_data[0].lane1_carNumber + ' - ' + nr_data[0].lane1_driver + ' (' + nr_data[0].lane1_group + ')');
                        }
                        $('#NxtLane1Row').show();
                    }

                    $('#NextRace').show();
                    
                }
                
            }
            // Additional logic to add some visual aids (Complete/Incomplete)
            else if ( parseFloat(t_data[0].heats_pct_complete) == 100 && parseFloat(t_data[0].runoffs_pct_complete) == 100 )
            {
                // Hide everything not required
                $('#HeatSummary').hide();
                $('#RunOffSummary').hide();
                $('#CurrentRace').hide();
                $('#NextRace').hide();
                // Show the "Races Complete" div
                $('#AllRacesComplete').show();
            }
        } 
        catch (error) 
        {
            showAlert('<div class="alert alert-danger alert-dismissible" role="alert">' +
                      '  <strong>Ooops!</strong> There was an error during retrieval of data. <a href="javascript:;" onclick="reload()" class="alert-link">Reload Page</a> OR <a href="/kubkars" class="alert-link">Start Again</a>. Error Text: ' +
                      error +
                      '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                      '</div>');
        }
    }

    function refreshTrackData()
    {
        // item is the option that was selected, might be the default or an actual track id
        var item = document.getElementById("frmTrackInput").value;
        sessionStorage.setItem('KubKarsScoutTrucks_TrackID',document.getElementById("frmTrackInput").value);
        
        if (item == "default")
        {
            // Hide everything when the default option is selected
            $('#TrackContent').hide();
        }
        else 
        {
            var dbID = sessionStorage.getItem("KubKarsScoutTrucks_dbID");
            // Refresh when a real option is selected
            if (dbID == 1 || dbID == 2)
            {
                if (dbID == 1)
                {
                    var TrackSummaryURL = window.location.origin + '/api/cubs/tracksummary/' + item;
                    var RaceURL = window.location.origin + '/api/cubs/race/' + item;
                    var VehiclesPerHeatURL = window.location.origin + '/api/cubs/vehicles_per_heat';
                }
                
                if (dbID == 2)
                {
                    var TrackSummaryURL = window.location.origin + '/api/scouts/tracksummary/' + item;
                    var RaceURL = window.location.origin + '/api/scouts/race/' + item;
                    var VehiclesPerHeatURL = window.location.origin + '/api/scouts/vehicles_per_heat';
                }
                // Show the Content
                $('#TrackContent').show();
                // Hide the track selector
                HideTrackSelector();
                // Refresh the summary and race data
                fetchAndPopulateRaceAndSummary(TrackSummaryURL,RaceURL,VehiclesPerHeatURL);
                // Update TrackID span element
                document.getElementById('CurrentTrack').innerHTML = htmlEncode(item);
            }
        }
    }
    
    $(document).ready(async function() 
    {
        var CurrentUserDiv = document.getElementById('CurrentUser');
        getCurrentUserId(CurrentUserDiv);
        
        // Add an event listener to look for changes to the selection of track
        document.getElementById("frmTrackInput").addEventListener("change", refreshTrackData);
        
        var dbID = sessionStorage.getItem("KubKarsScoutTrucks_dbID");
        var nmPerson = document.getElementById('CurrentUser').innerHTML;
        
        // Get the TrackID, must be an integer
        var TrackID = sessionStorage.getItem('KubKarsScoutTrucks_TrackID');
        num_trackID = parseInt(TrackID);
        document.getElementById('CurrentTrack').innerHTML = htmlEncode(num_trackID);
        
        // Must be a 1 or 2
        if (dbID == 1 || dbID == 2) 
        {
            // Change data source based on dbID
            if (dbID == 1) 
            {
                document.getElementById('MainHeader').innerHTML = htmlEncode('Kub Kars - Setting Up');
                var TracksUrl = window.location.origin + '/api/cubs/tracks';
            }
            
            if (dbID == 2) 
            {
                document.getElementById('MainHeader').innerHTML = htmlEncode('Scout Trucks - Setting Up');
                var TracksUrl = window.location.origin + '/api/scouts/tracks';
            }
            
            try 
            {
                // Put those Track Ids in the select dropdown.
                // Call the function to populate the Track List
                await fetchDataAndPopulateDropdown(TracksUrl);
                
                if (Number.isInteger(num_trackID)) {
                    // Make sure the option exists
                    if ( optionExists( TrackID, document.getElementById('frmTrackInput') ) )
                    {
                        // Select the Option based on the stored data
                        document.getElementById('frmTrackInput').value = num_trackID;
                        // Raise an event to force a refresh
                        document.getElementById('frmTrackInput').dispatchEvent(new Event('change'));
                        // If the TrackID is set, hide the selector
                        HideTrackSelector();
                    }
                    else
                    {
                          sessionStorage.removeItem('KubKarsScoutTrucks_TrackID');
                          ShowTrackSelector();
                          $('#TrackContent').hide();
                    }
                }
                else
                {
                    // If the trackid is not set, show the selector.
                    ShowTrackSelector();
                    $('#TrackContent').hide();
                }
                
            }
            catch (error) 
            {
                // draw an alert box with the error visible
                showAlert('<div class="alert alert-danger alert-dismissible" role="alert">' +
                          '  <strong>Ooops!</strong> There was an error during retrieval of data. <a href="javascript:;" onclick="reload()" class="alert-link">Reload Page</a>' +
                          error +
                          '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                          '</div>');
            }
            
            // Auto Refresh every 30s
            setInterval(refreshTrackData, 30000);
        }
        else 
        {
          
            // Show the alert
            showAlert('<div class="alert alert-danger alert-dismissible" role="alert">' +
                      '  <strong>Ooops!</strong> No Section data available. <a href="/kubkars" class="alert-link">Start Over</a>' +
                      '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                      '</div>');
        }

    });
 
  </script>
  
</head>

<body>

  <!-- Offcanvas Sidebar -->
  <div class="offcanvas offcanvas-start" id="RoleSwitcher">
    <div class="offcanvas-header">
      <h1 class="offcanvas-title">Switch Role</h1>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <p>Choose a role to switch to, or start again:</p>
      <p><br>
      <a href="/kubkars" class="btn btn-primary">Start Over</a>
      <p><br>
      <a href="/setting_up" class="btn btn-primary">Setting Up</a> 
      <p><br>
      <a href="/recording" class="btn btn-primary">Recording</a> 
      <p><br>
      <a href="/monitoring" class="btn btn-primary">Monitoring</a> 
      <p>
    </div>
  </div>
  
  <div class="container-fluid p-4 bg-primary text-white text-center">
    <h1 id="MainHeader"></h1>
    <!-- Button to open the offcanvas sidebar -->
    <button class="btn btn-secondary text-white" type="button" data-bs-toggle="offcanvas" data-bs-target="#RoleSwitcher">Switch Role</button>
    <!-- Button to switch tracks -->
    <button class="btn btn-secondary text-white" type="button" id="SwitchTracksButton" onclick="ShowHideTrackSelector()">Switch Tracks</button>
    <br>Current Track: <b><span id="CurrentTrack"></span></b>
    <br>Logged in as: <b><span id="CurrentUser"></span></b>
    <br><form action="/logout" method="post"><a class='text-white' href="javascript:;" onclick="parentNode.submit();">Log out</a></form>
  </div>

  <!-- Container for any alerts -->
  <div id="liveAlertPlaceholder"></div>
  
  <!-- Main Page Container -->
  <div class="container-fluid p-4 bg-white text-black text-center" id="mainPageContent">
  
    <!-- Selector for Track -->
    <!-- When the page is loaded, the right track is selected, and this is hidden -->
    <div id="TrackSelector">
      <br>
      <label for="frmTrackInput"><h4>Select Track:</h4></label>
      <select class="form-select" id="frmTrackInput" required>
        <option value="default" selected>Choose Track...</option>
      </select>
      <br>
    </div>
    <!-- Track Data -->
    <br>
    <div class="container" id="TrackContent">
      
      <!-- Current Heat -->
      <!-- Not all lanes will be shown, depends on Vehicles Per Heat setting. -->
      <div id="CurrentRace">
        <h4>Current Race</h4>
        <div class="container-fluid">
          <div class="row justify-content-center">
            <div class="col border bg-light text-end"><strong>Race #:</strong></div><div class="col border" id='CurRaceNum'></div>
          </div>
          <div class="row justify-content-center">
            <div class="col border bg-light text-end"><strong>Race Type:</strong></div><div class="col border" id='CurRaceType'></div>
          </div>
          <div class="row justify-content-center" id="CurLane1Row">
            <div class="col border bg-light text-end"><strong>Lane 1:</strong></div><div class="col border" id='CurLane1CarID'></div>
          </div>
          <div class="row justify-content-center" id="CurLane2Row">
            <div class="col border bg-light text-end"><strong>Lane 2:</strong></div><div class="col border" id='CurLane2CarID'></div>
          </div>
          <div class="row justify-content-center" id="CurLane3Row">
            <div class="col border bg-light text-end"><strong>Lane 3:</strong></div><div class="col border" id='CurLane3CarID'></div>
          </div>
          <div class="row justify-content-center" id="CurLane4Row">
            <div class="col border bg-light text-end"><strong>Lane 4:</strong></div><div class="col border" id='CurLane4CarID'></div>
          </div>
          <div class="row justify-content-center" id="CurLane5Row">
            <div class="col border bg-light text-end"><strong>Lane 5:</strong></div><div class="col border" id='CurLane5CarID'></div>
          </div>
          <div class="row justify-content-center" id="CurLane6Row">
            <div class="col border bg-light text-end"><strong>Lane 6:</strong></div><div class="col border" id='CurLane6CarID'></div>
          </div>
        </div>
        <br> 
      </div>
      
      <!-- Next Heat -->
      <!-- Not all lanes will be shown, depends on Vehicles Per Heat setting. -->
      <div id="NextRace">
        <h4>Next Race</h4>
        <div class="container-fluid">
          <div class="row justify-content-center">
            <div class="col border bg-light text-end"><strong>Race #:</strong></div><div class="col border" id='NxtRaceNum'></div>
          </div>
          <div class="row justify-content-center">
            <div class="col border bg-light text-end"><strong>Race Type:</strong></div><div class="col border" id='NxtRaceType'></div>
          </div>
          <div class="row justify-content-center" id="NxtLane1Row">
            <div class="col border bg-light text-end"><strong>Lane 1:</strong></div><div class="col border" id='NxtLane1CarID'></div>
          </div>
          <div class="row justify-content-center" id="NxtLane2Row">
            <div class="col border bg-light text-end"><strong>Lane 2:</strong></div><div class="col border" id='NxtLane2CarID'></div>
          </div>
          <div class="row justify-content-center" id="NxtLane3Row">
            <div class="col border bg-light text-end"><strong>Lane 3:</strong></div><div class="col border" id='NxtLane3CarID'></div>
          </div>
          <div class="row justify-content-center" id="NxtLane4Row">
            <div class="col border bg-light text-end"><strong>Lane 4:</strong></div><div class="col border" id='NxtLane4CarID'></div>
          </div>
          <div class="row justify-content-center" id="NxtLane5Row">
            <div class="col border bg-light text-end"><strong>Lane 5:</strong></div><div class="col border" id='NxtLane5CarID'></div>
          </div>
          <div class="row justify-content-center" id="NxtLane6Row">
            <div class="col border bg-light text-end"><strong>Lane 6:</strong></div><div class="col border" id='NxtLane6CarID'></div>
          </div>
        </div>
      </div>

      <!-- A heat summary at the bottom of the page -->
      <br>
      <div id="TrackSummary">
        <div id="HeatSummary">
          <h4>Heat Summary</h4>
          <div class="container-fluid">
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Total:</strong></div><div class="col border" id='statTotalHeats'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Finished:</strong></div><div class="col border" id='statFinishedHeats'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Unfinished:</strong></div><div class="col border" id='statUnfinishedHeats'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>% Complete:</strong></div><div class="col border" id='statHeatPercentComplete'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Current Heat:</strong></div><div class="col border" id='statCurrentHeat'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Next Heat:</strong></div><div class="col border" id='statNextHeat'></div>
            </div>
          </div>
        </div>
        <div id="RunOffSummary">
          <h4>Run-Off Summary</h4>
          <div class="container-fluid">
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Total RunOffs:</strong></div><div class="col border" id='statTotalRunOffs'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Finished:</strong></div><div class="col border" id='statFinishedRunOffs'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Unfinished:</strong></div><div class="col border" id='statUnfinishedRunOffs'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>% Complete:</strong></div><div class="col border" id='statROPercentComplete'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Current RunOff:</strong></div><div class="col border" id='statCurrentRunOff'></div>
            </div>
            <div class="row justify-content-center">
              <div class="col border bg-light text-end"><strong>Next RunOff:</strong></div><div class="col border" id='statNextRunOff'></div>
            </div>
          </div>
          <br>
        </div>
      </div>
      
      <!-- A Refresh Data Button -->
      <br>
      <button type="button" class="btn btn-primary" onclick="refreshTrackData()">Refresh</button>
      <br>
      
      <!-- A Hidden div, shown when all races are finished -->
      <div class="container-fluid collapse" id="AllRacesComplete">
          <h3>Racing Finished!</h3>
      </div>

    </div>
    
  
  
  </div>
  
</body>
</html>