<!DOCTYPE html>
<html lang="en-CA">
<head>
  <meta charset="utf-8">
  <title>Kub Kars and Scout Trucks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/libs/bootstrap-5.3.3-dist/css/bootstrap.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="/assets/images/Scouts-Badge.png">
  <script src="/libs/jquery-3.7.1.min.js" type="application/javascript"></script>
  <script src="/libs/bootstrap-5.3.3-dist/js/bootstrap.js" type="application/javascript"></script>
  <script src="/libs/popper.min.js" type="application/javascript"></script>
  <script src="/libs/common.js" type="application/javascript"></script>

  <script>
  
    // A function to show an alert when there is an error
    function showAlert(CustomInnerHTML) 
    {
        const alertPlaceholder = document.getElementById('liveAlertPlaceholder');
        const appendAlert = () => 
        {
            const wrapper = document.createElement('div');
            wrapper.innerHTML = [CustomInnerHTML].join('');
            alertPlaceholder.append(wrapper);
        }
        appendAlert();
    }
    
    // Taken from: https://getbootstrap.com/docs/5.0/forms/validation/
    // Example starter JavaScript for disabling form submissions if there are invalid fields
    
    (function () 
    {
        'use strict'
        
        // Fetch all the forms we want to apply custom Bootstrap validation styles to
        var forms = document.querySelectorAll('.needs-validation')
        
        // Loop over them and prevent submission
        Array.prototype.slice.call(forms)
          .forEach(function (form) {
            form.addEventListener('submit', function (event) {
              if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
              }
        
              form.classList.add('was-validated');
            }, false);
        });
        
    })();
    
    // Function called when the form is successfully completed
    
    function SetAndCheckStorage()
    {
    
        // Change to Local Storage
        sessionStorage.setItem('KubKarsScoutTrucks_TrackID',document.getElementById("frmTrackInput").value);
        sessionStorage.setItem('KubKarsScoutTrucks_dbID',document.getElementById("frmSectionInput").value);
        sessionStorage.setItem('KubKarsScoutTrucks_role',document.getElementById("frmRoleInput").value);
        
        // Check that setting the storage values actually worked
        if (sessionStorage.getItem('KubKarsScoutTrucks_dbID') != document.getElementById("frmSectionInput").value)
        {
            return false;
        }
        
        if (sessionStorage.getItem('KubKarsScoutTrucks_role') != document.getElementById("frmRoleInput").value) 
        {
            return false;
        }
        
        if (sessionStorage.getItem('KubKarsScoutTrucks_TrackID') != document.getElementById("frmTrackInput").value) 
        {
            return false;
        }
        
        return true;
    }
    
    function CheckBeforeFormSubmit()
    {
    
        var SetAndCheck = SetAndCheckStorage();
        
        if (SetAndCheck == true) 
        {
        
            // Get the TrackID, must be an integer
            var TrackID = sessionStorage.getItem('KubKarsScoutTrucks_TrackID');
            num_trackID = parseInt(TrackID);
            
            // Get the dbID value based on the selection:
            var dbID = sessionStorage.getItem('KubKarsScoutTrucks_dbID');
            
            // Get the role
            var vrole = sessionStorage.getItem('KubKarsScoutTrucks_role');
            
            // dbID Must be a 1 or 2, TrackID must be an integer, Role must be r1, r2, r3
            if ((dbID == 1 || dbID == 2) & Number.isInteger(num_trackID) & (vrole == "r1" || vrole == "r2" || vrole == "r3"))
            {
                if ( document.getElementById("frmRoleInput").value == "r1" )
                {
                    document.getElementById("frmIndex").action = "/setting_up";
                }
                else if ( document.getElementById("frmRoleInput").value == "r2" ) 
                {
                    document.getElementById("frmIndex").action = "/recording";
                } 
                else if ( document.getElementById("frmRoleInput").value == "r3" ) 
                {
                    document.getElementById("frmIndex").action = "/monitoring";
                }
                
                document.getElementById("frmIndex").submit();
            }
            else
            {
                // The user must make a selection
                showAlert('<div class="alert alert-warning alert-dismissible" role="alert">' +
                          '  <strong>Ooops!</strong> Please finish making your selections before continuing. ' +
                          '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                          '</div>');
            }
        }
        else
        {
            showAlert('<div class="alert alert-danger alert-dismissible" role="alert">' +
                      '  <strong>Ooops!</strong> There was a problem using local storage. <a href="javascript:;" onclick="reload()" class="alert-link">Reload Page</a>. ' +
                      '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                      '</div>');
        }
    }
    
    // Show the role information when it is selected
    // Since there's only three, just hide them all and show what was chosen
    
    function showSelectedItem() 
    {
        var e = document.getElementById("frmRoleInput");
        var item = e.value;
        
        if (item == "r1" || item == "r2" || item == "r3")
        {
            document.getElementById('ModalTitle').innerHTML = e.options[e.selectedIndex].text;
            document.getElementById('r1').style.display = "none";
            document.getElementById('r2').style.display = "none";
            document.getElementById('r3').style.display = "none";
            document.getElementById(item).style.display = "block";
            $('#RoleWarningBox').modal('show');
        }
    }
    
    // Change the track list when the section changes
    
    function switchSections()
    {
        // Clear the track selector
        // We do this because we are connecting to two different databases, and the track list may be different
        selector = document.getElementById("frmTrackInput");
        
        // Loop backwards from the last option to the second option (index 1)
        for (let i = selector.options.length - 1; i > 0; i--) {
            selector.remove(i);
        }
        
        // Set the item in storage
        sessionStorage.setItem('KubKarsScoutTrucks_dbID',document.getElementById("frmSectionInput").value);
        
        // Get the dbID value based on the selection:
        var dbID = sessionStorage.getItem('KubKarsScoutTrucks_dbID');
        
        // Must be a 1 or 2
        if (dbID == 1 || dbID == 2) 
        {
            
            // Change data source based on stored value
            if (dbID == 1) 
            {
                var TracksUrl = window.location.origin + '/api/cubs/tracks';
            }
            
            if (dbID == 2)
            {
                var TracksUrl = window.location.origin + '/api/scouts/tracks';
            }
            
            try 
            {
                // Put those Track Ids in the select dropdown.
                // Call the function to populate the Track List
                fetchDataAndPopulateDropdown(TracksUrl);
            } 
            catch (error) 
            {
                // draw an alert box with the error visible
                showAlert('<div class="alert alert-danger alert-dismissible" role="alert">' +
                          '  <strong>Ooops!</strong> There was an error during retrieval of data. <a href="javascript:;" onclick="reload()" class="alert-link">Reload Page</a> Error Text:' +
                          error +
                          '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                          '</div>');
            }
        }
    }
    
    // A function to call the API to put the Track IDs in the dropdown
    async function fetchDataAndPopulateDropdown(apiurl)
    {
        try
        {
            const response = await fetch(apiurl);
            if (!response.ok)
            {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const data = await response.json();
            const dropdown = document.getElementById('frmTrackInput');
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.track;
                option.textContent = item.track;
                dropdown.appendChild(option);
            });
        } 
        catch (error)
        {
            showAlert('<div class="alert alert-danger alert-dismissible" role="alert">' +
                      '  <strong>Ooops!</strong> There was an error during retrieval of data. <a href="javascript:;" onclick="reload()" class="alert-link">Reload Page</a>. Error Text: ' +
                      error +
                      '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                      '</div>');
        }
    }
    
    $(document).ready(function()
    {
        var CurrentUserDiv = document.getElementById('CurrentUser');
        getCurrentUserId(CurrentUserDiv);
        
        document.getElementById("frmRoleInput").addEventListener("change", showSelectedItem);
        document.getElementById('r1').style.display = "none";
        document.getElementById('r2').style.display = "none";
        document.getElementById('r3').style.display = "none";
        
        // Listen for changes to the Section; this affects where we get the track listing from:
        document.getElementById("frmSectionInput").addEventListener("change", switchSections);
        
    });
  
  </script>

</head>
<body>

  <!-- Modal box, shows the warning of what the roles do -->
  <div class="modal" id="RoleWarningBox">
    <div class="modal-dialog">
      <div class="modal-content">
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title" id="ModalTitle"></h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <!-- Modal body -->
        <div class="modal-body">
          <div class="collapse" id="r1">
            <p>You will be responsible for making sure the right cars are placed at the head of the track</p>
            <p>This app will tell you who is racing, and who is up next.</p>
            <p>You <b>will not</b> be able to record results in this mode.</p>
          </div>
          <div class="collapse" id="r2">
            <p>You will be responsible for making sure the right results are recorded for each race.</p>
            <p>Keep an eye on which lane finishes 1st, 2nd or 3rd, and make sure you record it before moving on to the next race.</p>
          </div>
          <div class="collapse" id="r3">
            <p>In this mode, you can keep track of how many races are finished, and how many are still pending.</p>
          </div>
        </div>
        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="modalbutton">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid p-4 bg-info text-white text-center">
    <h1>Kub Kars and Scout Trucks Racing App</h1>
    <h4>Please choose your role</h4>
    <br>Logged in as: <b><span id="CurrentUser"></span></b>
    <br><form action="/logout" method="post"><a href="javascript:;" onclick="parentNode.submit();">Log out</a></form>
  </div>
  
  <div class="container-fluid p-4 bg-white text-black text-center">

    <!-- Container for any login alerts -->
    <div id="liveAlertPlaceholder"></div>

    <form class="row gy-2 gx-3 align-items-center" id="frmIndex">
  
      <!-- Section Field -->
      <div class="mb-3 row g-3">
        <label class="visually-hidden" for="frmSectionInput">Section</label>
        <select class="form-select" id="frmSectionInput" required>
          <option selected>Choose Section...</option>
          <option value="1">Cubs</option>
          <option value="2">Scouts</option>
        </select>
        <div class="invalid-feedback">
          Please choose a section.
        </div>
      </div>
      <!-- Role Field -->
      <div class="mb-3 row g-3">
        <label class="visually-hidden" for="frmRoleInput">Role</label>
        <select class="form-select" id="frmRoleInput" required>
          <option selected>Choose Role...</option>
          <option value="r1">Setting Up</option>
          <option value="r2">Recording</option>
          <option value="r3">Monitoring</option>
        </select>
        <div class="invalid-feedback">
          Please choose a role.
        </div>
      </div>
      <!-- Track Selector -->
      <div class="mb-3 row g-3">
        <label class="visually-hidden" for="frmTrackInput">Select Track:</label>
        <select class="form-select" id="frmTrackInput" required>
          <option value="default" selected>Choose Track...</option>
        </select>
      </div>
      <!-- Submit Button -->
      <div class="mb-3 row g-3">
        <button type="button" id="btnsubmit" onclick="CheckBeforeFormSubmit()" class="btn btn-primary">Submit</button>
      </div>
    </form>
  </div>
</body>

</html>